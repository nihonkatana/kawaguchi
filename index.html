<!doctype html>
<html lang="ja">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é¸æŒ™æ²ç¤ºæ¿ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>
    :root { --bg:#0b0f1a; --card:#121a2b; --muted:#a7b0c0; --text:#eef2ff; --accent:#4f8cff; --danger:#ff5c5c; --ok:#2fe27d; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:720px;margin:0 auto;padding:16px 14px 90px}
    .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(to bottom, rgba(11,15,26,.98), rgba(11,15,26,.80));backdrop-filter: blur(10px);padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .row{display:flex;gap:10px;align-items:center}
    .space{justify-content:space-between}
    .title{font-size:16px;font-weight:700}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);color:var(--muted)}
    .btn{border:none;border-radius:12px;padding:12px 14px;font-weight:700;font-size:14px;background:rgba(255,255,255,.10);color:var(--text);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent)}
    .btn.ok{background:var(--ok); color:#052012}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14)}
    .btn.small{padding:9px 10px;font-size:13px;border-radius:10px}
    .btn.block{width:100%}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    .h2{font-size:15px;font-weight:800;margin:0 0 8px}
    .h3{font-size:13px;font-weight:800;margin:0 0 6px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .field{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);outline:none}
    .field::placeholder{color:rgba(167,176,192,.7)}
    .tabs{position:fixed;left:0;right:0;bottom:0;background:rgba(18,26,43,.96);backdrop-filter: blur(10px);border-top:1px solid rgba(255,255,255,.12);padding:10px 12px;display:flex;gap:10px;z-index:60}
    .tab{flex:1;text-align:center;padding:10px;border-radius:12px;font-weight:800;font-size:13px;color:var(--muted);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);cursor:pointer}
    .tab.active{color:var(--text);background:rgba(79,140,255,.20);border-color:rgba(79,140,255,.50)}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);color:var(--muted)}
    .bTodo{background:rgba(79,140,255,.18);color:#b8d4ff}
    .bDone{background:rgba(47,226,125,.18);color:#a9ffd0}
    .sep{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05)}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTitle{font-weight:900;font-size:14px;line-height:1.25}
    .itemSub{font-size:12px;color:var(--muted);margin-top:4px;white-space:pre-wrap}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .right{display:flex;gap:8px;align-items:center}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi .pill{background:rgba(255,255,255,.06)}
    .toast{position:fixed;left:14px;right:14px;top:14px;z-index:100;display:none}
    .toast.show{display:block}
    .toast .card{margin:0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
    .checkbox{transform:scale(1.15)}
    .tiny{font-size:11px;color:rgba(167,176,192,.85)}

    /* settings button */
    #btnSettings{
      position:fixed; right:12px; top:12px; z-index:1000;
      padding:10px 12px; border-radius:999px;
      background:rgba(255,255,255,.10); color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row space">
      <div class="title">é¸æŒ™æ²ç¤ºæ¿ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</div>
      <div class="right">
        <span id="rolePill" class="pill">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
      </div>
    </div>
    <div class="row space" style="margin-top:10px">
      <div class="kpi">
        <span class="pill" id="userPill">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-</span>
        <span class="pill" id="modePill">ç§»å‹•ï¼šè»Š</span>
      </div>
      <button class="btn small" onclick="app.reload()">æ›´æ–°</button>
    </div>
  </div>

  <button id="btnSettings" aria-label="è¨­å®š">âš™ï¸</button>

  <div class="toast" id="toast"><div class="card"><div id="toastText"></div></div></div>

  <div class="wrap">
    <!-- AUTH / REGISTER -->
    <div id="authView" class="card" style="display:none">
      <div class="h2">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆå›ç™»éŒ²ï¼‰</div>
      <div class="muted" style="font-size:12px;line-height:1.55">
        ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨è­˜åˆ¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        è­˜åˆ¥åã¯ã€LINEè¡¨ç¤ºåãŒã‚ã‚‹æ–¹ã¯ãã®è¡¨ç¤ºåã€‚LINEãŒãªã„æ–¹ã¯å‘¨å›²ãŒè­˜åˆ¥ã§ãã‚‹åå‰ï¼ˆç­åï¼‹æ°åãªã©ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      </div>
      <div style="margin-top:12px">
        <div class="h3">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰</div>
        <input id="inNick" class="field" placeholder="ä¾‹ï¼šã”ã¾ã¡ã‚ƒã‚“ / Aç­ç”°ä¸­" />
      </div>
      <div style="margin-top:10px">
        <div class="h3">è­˜åˆ¥åï¼ˆå¿…é ˆï¼‰</div>
        <input id="inIdName" class="field" placeholder="ä¾‹ï¼šæ˜çŸ³å®¶ ã‚´ãƒ / Aç­ ç”°ä¸­" />
      </div>
      <div class="sep"></div>
      <button class="btn primary block" onclick="app.register()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="tiny" style="margin-top:10px">
        ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„å ´åˆï¼šè²¬ä»»è€…ã«ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã¨ã€Œè­˜åˆ¥åã€ã‚’ä¼ãˆã¦ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç™»éŒ²ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚<br>
        ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã®ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã€Œè­˜åˆ¥åã€ã«å®Œå…¨ä¸€è‡´ï¼ˆç©ºç™½ã‚†ã‚Œã¯å¸åï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚
      </div>
    </div>

    <!-- FIELD -->
    <div id="fieldView" style="display:none">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">æ‹…å½“æŠ•ç¥¨åŒº</div>
            <div class="muted" style="font-size:12px">å‰²å½“ã•ã‚ŒãŸæŠ•ç¥¨åŒºï¼ˆP###ï¼‰ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
          </div>
          <button class="btn small" onclick="app.openTravelModePicker()">ç§»å‹•æ‰‹æ®µ</button>
        </div>
        <div class="sep"></div>
        <div id="precinctList" class="list"></div>
      </div>

      <div id="precinctDetail" class="card" style="display:none">
        <div class="row space">
          <div>
            <div class="h2" id="precTitle">æŠ•ç¥¨åŒº</div>
            <div class="muted" id="precSub" style="font-size:12px"></div>
          </div>
          <button class="btn small ghost" onclick="app.closePrecinct()">æˆ»ã‚‹</button>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <button class="btn primary block" onclick="app.startNavRecommended()">æ¬¡ã®1åœ°ç‚¹ãƒŠãƒ“ï¼ˆæœªè¨ªå•å…ˆé ­ï¼‰</button>
          <button class="btn block" onclick="app.pickNextPoint()">æ¬¡ç‚¹ã‚’é¸ã¶</button>
        </div>

        <div class="muted" style="font-size:12px;margin-top:8px;line-height:1.5">
          ãƒ«ãƒ¼ãƒ«ï¼šæœªè¨ªå•(todo)ã®ã¿ãƒ»è¨­ç½®ç•ªå·é †ã€‚<br>
          åœ°å›³ã®ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ãƒŠãƒ“ / æ¸ˆ / æœªã«æˆ»ã™ / ãƒ¡ãƒ¢ ãŒã§ãã¾ã™ã€‚<br>
          â€»ãƒŠãƒ“ã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ï¼ˆæˆ»ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰ã€‚
        </div>

        <div class="sep"></div>

        <!-- Leaflet map -->
        <div id="mapWrap" class="card" style="display:none; margin:0 0 12px 0">
          <div class="row space">
            <div>
              <div class="h2">åœ°å›³ï¼ˆæŠ•ç¥¨åŒºå†…ï¼‰</div>
              <div class="muted" style="font-size:12px;margin-top:4px">
                ãƒ”ãƒ³ãŒå¤šã„æŠ•ç¥¨åŒºã¯è‡ªå‹•ã§ã¾ã¨ã‚è¡¨ç¤ºï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ï¼‰ã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
            <button class="btn small" onclick="app.recenterToMyLocation()">ç¾åœ¨åœ°ã¸</button>
          </div>

          <div class="sep"></div>

          <!-- filters -->
          <div class="grid3" style="margin-bottom:10px">
            <button class="btn small" id="btnFilterAll" onclick="app.setMapFilter('all')">å…¨ã¦</button>
            <button class="btn small" id="btnFilterTodo" onclick="app.setMapFilter('todo')">æœªã®ã¿</button>
            <button class="btn small" id="btnFilterDone" onclick="app.setMapFilter('done')">æ¸ˆã®ã¿</button>
          </div>

          <div id="map" style="height: 380px; border-radius:14px; overflow:hidden;"></div>

          <div class="tiny" id="gpsHint" style="margin-top:10px; line-height:1.35">
            â€»ç¾åœ¨åœ°ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±ã‚’ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>

        <div id="pointList" class="list"></div>
      </div>
    </div>

    <!-- ALLOCATOR -->
    <div id="allocView" style="display:none">
      <div class="card">
        <div class="h2">å‰²å½“ï¼ˆè²¬ä»»è€…ï¼‰</div>
        <div class="muted" style="font-size:12px;line-height:1.5">
          è¤‡æ•°äººåŒæ™‚æ“ä½œã‚’æƒ³å®šã—ã€æŠ•ç¥¨åŒºã”ã¨ã« version ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ç«¶åˆã—ãŸå ´åˆã¯ã€Œç«¶åˆã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆæ›´æ–°ã—ã¦ã‚„ã‚Šç›´ã—ï¼‰ã€‚
        </div>
        <div class="sep"></div>

        <div class="h3">æ‹…å½“è€…æ¤œç´¢ï¼ˆusersï¼‰</div>
        <input id="inUserSearch" class="field" placeholder="è¡¨ç¤ºåã§æ¤œç´¢ï¼ˆä¾‹ï¼šãŸãªã‹ï¼‰" oninput="app.renderUserCandidates()" />
        <div id="userCandidates" class="list" style="margin-top:10px"></div>

        <div class="sep"></div>

        <div class="h3">æŠ•ç¥¨åŒºä¸€è¦§</div>
        <div class="muted" style="font-size:12px;margin-bottom:8px">è¤‡æ•°é¸æŠã—ã¦ä¸€æ‹¬å‰²å½“ã§ãã¾ã™ã€‚</div>

        <div class="grid2">
          <button class="btn ok block" onclick="app.bulkAssign()">é¸æŠã‚’å‰²å½“</button>
          <button class="btn ghost block" onclick="app.bulkUnassign()">é¸æŠã‚’è§£é™¤</button>
        </div>

        <div style="margin-top:10px">
          <input id="inAssignNote" class="field" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šåˆå‰æ‹…å½“/å¼•ãç¶™ãç­‰ï¼‰" />
        </div>

        <div class="sep"></div>
        <div id="assignList" class="list"></div>
      </div>

      <div class="card">
        <div class="h2">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼ˆallowlistï¼‰</div>
        <div class="muted" style="font-size:12px">ç¾å ´ã‹ã‚‰é€£çµ¡ãŒæ¥ãŸã‚‰ã€ãã®å ´ã§ç™»éŒ²ã§ãã¾ã™ã€‚</div>
        <div class="sep"></div>

        <div class="h3">è¿½åŠ </div>
        <div class="grid2">
          <input id="alNick" class="field" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰" />
          <input id="alIdName" class="field" placeholder="è­˜åˆ¥åï¼ˆå¿…é ˆï¼‰" />
        </div>
        <div style="margin-top:10px">
          <input id="alNote" class="field" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šç­/ç‰¹å¾´/é›»è©±æœ«å°¾ç­‰ï¼‰" />
        </div>
        <div style="margin-top:10px">
          <button class="btn primary block" onclick="app.allowlistAdd()">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        </div>

        <div class="sep"></div>
        <div class="h3">ç„¡åŠ¹åŒ–</div>
        <input id="alDisableId" class="field" placeholder="allow_idï¼ˆä¾‹ï¼šal_000123ï¼‰" />
        <div style="margin-top:10px">
          <button class="btn ghost block" onclick="app.allowlistDisable()">ã“ã® allow_id ã‚’ç„¡åŠ¹åŒ–</button>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs" id="tabs" style="display:none">
    <div class="tab active" id="tabField" onclick="app.switchTab('field')">ç¾å ´</div>
    <div class="tab" id="tabAlloc" onclick="app.switchTab('alloc')">è²¬ä»»è€…</div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1001;">
    <div style="background:#fff; margin:12vh auto; padding:16px; width:min(92vw,420px); border-radius:12px; color:#111;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; font-size:16px;">è¨­å®š</h2>
        <button id="btnCloseSettings" style="padding:6px 10px;">âœ•</button>
      </div>

      <div id="currentUserBox" style="margin-top:12px; font-size:14px; opacity:.85;"></div>

      <hr style="margin:12px 0;">

      <button id="btnLogoutInSettings" style="width:100%; padding:10px;">
        ã“ã®ç«¯æœ«ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>

      <p style="font-size:12px; opacity:.7; margin-top:10px;">
        â€»ç«¯æœ«ã‚’ä»–ã®äººã¨å…±ç”¨ã™ã‚‹å ´åˆã®ã¿ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚é€šå¸¸ã¯ä¸è¦ã§ã™ã€‚
      </p>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/** =========================
 *  CONFIG
 * ========================= */
// â˜…ã“ã“ã‚’ã‚ãªãŸã®GAS Webã‚¢ãƒ—ãƒªURLã«ç½®æ›ã—ã¦ãã ã•ã„
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxC3grMv-FZvGvOB2XR4CpUKmTotB5bsE-HontXPzl4zM6JSEzW2v-sY_k4r2ncSvESMw/exec";

/** =========================
 *  STATE
 * ========================= */
const store = {
  user_id: localStorage.getItem("user_id") || "",
  display_name: localStorage.getItem("display_name") || "",
  role: localStorage.getItem("role") || "",
  travel_mode: localStorage.getItem("travel_mode") || "driving", // driving|walking
  assigned_areas: [],
  points: [],
  state: {},         // point_id -> {status,memo}
  current_area: "",

  // map filter
  map_filter: "all", // all|todo|done

  // gps
  my_latlng: null,
  gps_watch_id: null,

  // allocator caches
  allUsers: [],
  assignments: [],
  selectedAssignee: null,
  selectedAreas: new Set(),
};

const ui = {
  toast: (msg) => {
    const t = document.getElementById("toast");
    const tx = document.getElementById("toastText");
    tx.innerHTML = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2400);
  },
  setTop: () => {
    document.getElementById("userPill").textContent = store.display_name ? `ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${store.display_name}` : "ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-";
    const modeLabel = (store.travel_mode === "walking") ? "å¾’æ­©" : "è»Š";
    document.getElementById("modePill").textContent = `ç§»å‹•ï¼š${modeLabel}`;
    document.getElementById("rolePill").textContent = store.role ? `role: ${store.role}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
  }
};

/** =========================
 *  Utils
 * ========================= */
function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}
function escapeHtml_(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function statusBadge(status){
  if (status === "done") return `<span class="badge bDone">æ¸ˆ</span>`;
  return `<span class="badge bTodo">æœª</span>`;
}

/** =========================
 *  HTTP
 * ========================= */
async function postAction(payload) {
  if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes("PASTE_YOUR")) {
    ui.toast("GAS_WEBAPP_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    throw new Error("Missing GAS_WEBAPP_URL");
  }
  const res = await fetch(GAS_WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload),
  });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error("Bad JSON response: " + text.slice(0,200)); }
  return data;
}

/** =========================
 *  NAV URL (single only)
 * ========================= */
function buildAppleSingleUrl(lat, lng, travelMode){
  const dirflg = (travelMode === "walking") ? "w" : "d";
  const daddr = encodeURIComponent(`${Number(lat).toFixed(7)},${Number(lng).toFixed(7)}`);
  return `https://maps.apple.com/?daddr=${daddr}&dirflg=${dirflg}`;
}
function buildGoogleSingleUrl(lat, lng, travelMode){
  const mode = (travelMode === "walking") ? "walking" : "driving";
  const dest = encodeURIComponent(`${Number(lat).toFixed(7)},${Number(lng).toFixed(7)}`);
  return `https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=${encodeURIComponent(mode)}`;
}

/** =========================
 *  Leaflet Map UI (precinct detail only)
 * ========================= */
const mapUI = {
  map: null,
  cluster: null,
  markers: new Map(), // point_id -> marker

  myMarker: null,
  myAccuracyCircle: null,

  ensure(){
    if (this.map) return;
    this.map = L.map("map", { zoomControl:true });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(this.map);

    this.cluster = L.markerClusterGroup({
      chunkedLoading: true, // heavy precincts
      removeOutsideVisibleBounds: true,
      spiderfyOnMaxZoom: true
    });
    this.map.addLayer(this.cluster);
  },

  iconForStatus(st){
    const c = (st === "done") ? "#2fe27d" : "#4f8cff";
    return L.divIcon({
      className: "",
      html: `<div style="width:14px;height:14px;border-radius:999px;background:${c};border:2px solid rgba(255,255,255,.9);box-shadow:0 2px 10px rgba(0,0,0,.25)"></div>`,
      iconSize: [14,14],
      iconAnchor: [7,7],
    });
  },

  clearPoints(){
    if (!this.cluster) return;
    this.cluster.clearLayers();
    this.markers.clear();
  },

  clearMyLocation(){
    if (this.myMarker) { this.map.removeLayer(this.myMarker); this.myMarker = null; }
    if (this.myAccuracyCircle) { this.map.removeLayer(this.myAccuracyCircle); this.myAccuracyCircle = null; }
  },

  setMyLocation(lat, lng, accuracy){
    if (!this.map) return;
    const ll = [lat, lng];
    if (!this.myMarker) {
      this.myMarker = L.circleMarker(ll, {
        radius: 7,
        weight: 2,
        color: "#ffffff",
        fillColor: "#3aa0ff",
        fillOpacity: 0.95
      }).addTo(this.map);
      this.myMarker.bindPopup("ç¾åœ¨åœ°");
    } else {
      this.myMarker.setLatLng(ll);
    }

    if (typeof accuracy === "number" && isFinite(accuracy)) {
      if (!this.myAccuracyCircle) {
        this.myAccuracyCircle = L.circle(ll, {
          radius: accuracy,
          weight: 1,
          color: "rgba(58,160,255,.9)",
          fillColor: "rgba(58,160,255,.25)",
          fillOpacity: 0.25
        }).addTo(this.map);
      } else {
        this.myAccuracyCircle.setLatLng(ll);
        this.myAccuracyCircle.setRadius(accuracy);
      }
    }
  },

  render(area){
    document.getElementById("mapWrap").style.display = "block";
    this.ensure();
    this.clearPoints();

    // update filter button UI
    app.syncFilterButtons_();

    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    if (pts.length === 0) return;

    const bounds = [];
    for (const p of pts) {
      const st = store.state[p.point_id]?.status || "todo";

      if (store.map_filter === "todo" && st !== "todo") continue;
      if (store.map_filter === "done" && st !== "done") continue;

      const mk = L.marker([p.lat, p.lng], { icon: this.iconForStatus(st) });
      this.cluster.addLayer(mk);
      this.markers.set(p.point_id, mk);
      bounds.push([p.lat, p.lng]);
      mk.on("click", () => this.openPopup(p));
    }

    // if filter removed everything, fit to all points instead of empty
    const fitPts = (bounds.length > 0) ? bounds : pts.map(p => [p.lat, p.lng]);
    this.map.fitBounds(fitPts, { padding:[24,24] });
  },

  refreshPoint(point_id){
    const mk = this.markers.get(point_id);
    if (!mk) return;
    const st = store.state[point_id]?.status || "todo";
    mk.setIcon(this.iconForStatus(st));
  },

  openPopup(p){
    const memo = store.state[p.point_id]?.memo || "";
    const title = `#${p.order_reco} / ${p.point_id}`;

    const html = `
      <div style="font-size:13px;font-weight:900;margin-bottom:6px">${title}</div>
      <div style="font-size:12px;opacity:.85;white-space:pre-wrap">${escapeHtml_((p.name||"").trim())}\n${escapeHtml_((p.address||"").trim())}</div>
      ${memo ? `<div style="font-size:12px;margin-top:6px">ğŸ“ ${escapeHtml_(memo)}</div>` : ``}
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">
        <button onclick="app.startSingleNav('${p.point_id}')" style="padding:8px 10px;border-radius:10px;border:none;background:#4f8cff;color:#fff;font-weight:800">
          ãƒŠãƒ“
        </button>
        <button onclick="app.handlePointAction('done','${p.point_id}')" style="padding:8px 10px;border-radius:10px;border:none;background:#2fe27d;color:#052012;font-weight:900">æ¸ˆ</button>
        <button onclick="app.handlePointAction('todo','${p.point_id}')" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.15);background:#fff;color:#111;font-weight:800">æœªã«æˆ»ã™</button>
        <button onclick="app.handlePointAction('memo','${p.point_id}')" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.15);background:#fff;color:#111;font-weight:800">ãƒ¡ãƒ¢</button>
      </div>
    `;

    const mk = this.markers.get(p.point_id);
    if (mk) mk.bindPopup(html).openPopup();
  }
};

/** =========================
 *  GPS helpers
 * ========================= */
function startGpsWatch_(){
  const hint = document.getElementById("gpsHint");
  if (!navigator.geolocation) {
    hint.textContent = "â€»ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚";
    return;
  }
  // already watching
  if (store.gps_watch_id != null) return;

  store.gps_watch_id = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      store.my_latlng = { lat, lng, acc };
      hint.textContent = "ç¾åœ¨åœ°ï¼šå–å¾—ä¸­ï¼ˆè¡¨ç¤ºä¸­ï¼‰";
      mapUI.setMyLocation(lat, lng, acc);
    },
    (err) => {
      hint.textContent = "â€»ç¾åœ¨åœ°ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
      // do not spam toast repeatedly
    },
    { enableHighAccuracy: true, maximumAge: 15000, timeout: 12000 }
  );
}

function stopGpsWatch_(){
  if (store.gps_watch_id != null && navigator.geolocation) {
    navigator.geolocation.clearWatch(store.gps_watch_id);
    store.gps_watch_id = null;
  }
}

/** =========================
 *  APP
 * ========================= */
const app = {
  async init(){
    ui.setTop();
    app.bindSettings();
    if (!store.user_id) {
      app.showAuth();
      return;
    }
    await app.bootstrap();
  },

  showAuth(){
    document.getElementById("authView").style.display = "block";
    document.getElementById("fieldView").style.display = "none";
    document.getElementById("allocView").style.display = "none";
    document.getElementById("tabs").style.display = "none";
  },

  async register(){
    const nickname = document.getElementById("inNick").value.trim();
    const id_name  = document.getElementById("inIdName").value.trim();
    if (!nickname || !id_name) { ui.toast("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    ui.toast("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
    const data = await postAction({ action:"register", nickname, id_name });
    if (!data.ok) {
      if (data.error === "NOT_ALLOWED") ui.toast("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæœªç™»éŒ²/ç„¡åŠ¹ï¼‰");
      else ui.toast("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + (data.error || "ä¸æ˜"));
      return;
    }

    store.user_id = data.user.user_id;
    store.display_name = data.user.display_name;
    store.role = data.user.role;

    localStorage.setItem("user_id", store.user_id);
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);
    localStorage.setItem("travel_mode", store.travel_mode);

    ui.setTop();
    await app.bootstrap();
  },

  async bootstrap(){
    ui.toast("èª­ã¿è¾¼ã¿ä¸­â€¦");
    const data = await postAction({ action:"bootstrap", user_id: store.user_id });
    if (!data.ok) {
      ui.toast("èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™");
      app.logout();
      return;
    }

    store.display_name = data.user.display_name || store.display_name;
    store.role = data.user.role || store.role;
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);

    store.assigned_areas = data.assigned_areas || [];
    store.points = data.points || [];
    store.state = data.state || {};

    ui.setTop();

    const tabs = document.getElementById("tabs");
    tabs.style.display = "flex";
    const canAlloc = (store.role === "allocator" || store.role === "planner");
    document.getElementById("tabAlloc").style.display = canAlloc ? "block" : "none";

    app.switchTab("field");
    app.renderPrecinctList();
  },

  async reload(){
    if (!store.user_id) { app.showAuth(); return; }
    await app.bootstrap();
    if (store.role === "allocator" || store.role === "planner") {
      if (document.getElementById("tabAlloc").classList.contains("active")) {
        await app.loadAllocatorData();
      }
    }
  },

  logout(){
    localStorage.removeItem("user_id");
    localStorage.removeItem("display_name");
    localStorage.removeItem("role");
    store.user_id = "";
    store.display_name = "";
    store.role = "";
    store.assigned_areas = [];
    store.points = [];
    store.state = {};
    store.current_area = "";
    stopGpsWatch_();
    ui.setTop();
    app.showAuth();
  },

  switchTab(which){
    document.getElementById("tabField").classList.toggle("active", which==="field");
    document.getElementById("tabAlloc").classList.toggle("active", which==="alloc");

    document.getElementById("fieldView").style.display = which==="field" ? "block" : "none";
    document.getElementById("allocView").style.display = which==="alloc" ? "block" : "none";
    document.getElementById("authView").style.display = "none";

    if (which==="alloc") {
      if (!(store.role === "allocator" || store.role === "planner")) {
        ui.toast("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
        app.switchTab("field");
        return;
      }
      app.loadAllocatorData().catch(err => ui.toast("å‰²å½“ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ï¼š" + err.message));
    }
  },

  openTravelModePicker(){
    const current = store.travel_mode;
    const opts = [
      {key:"driving", label:"è»Šï¼ˆãŠã™ã™ã‚ï¼‰"},
      {key:"walking", label:"å¾’æ­©"},
    ];
    const msg = opts.map(o => `${o.key===current?"â—":"â—‹"} ${o.label}`).join("\n");
    const chosen = prompt("ç§»å‹•æ‰‹æ®µã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆdriving / walkingï¼‰\n\n" + msg, current);
    if (!chosen) return;
    const v = chosen.trim();
    if (!["driving","walking"].includes(v)) { ui.toast("å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); return; }
    store.travel_mode = v;
    localStorage.setItem("travel_mode", store.travel_mode);
    ui.setTop();
    ui.toast("ç§»å‹•æ‰‹æ®µã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
  },

  /** -------- Field -------- */
  renderPrecinctList(){
    const el = document.getElementById("precinctList");
    el.innerHTML = "";

    if (!store.assigned_areas || store.assigned_areas.length === 0) {
      el.innerHTML = `
        <div class="item">
          <div class="itemTitle">å‰²å½“ãªã—</div>
          <div class="itemSub">è²¬ä»»è€…ãŒæŠ•ç¥¨åŒºã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¾ã§ã€ã“ã“ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
        </div>`;
      return;
    }

    const pointsByArea = new Map();
    for (const p of store.points) {
      if (!pointsByArea.has(p.area_id)) pointsByArea.set(p.area_id, []);
      pointsByArea.get(p.area_id).push(p);
    }

    for (const area of store.assigned_areas.slice().sort()) {
      const pts = (pointsByArea.get(area) || []).slice().sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));
      const total = pts.length;
      const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;
      const done = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="done").length;

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${area}ï¼ˆæŠ•ç¥¨åŒºï¼‰</div>
            <div class="itemSub">åœ°ç‚¹ï¼š${total} / æœªï¼š${todo} / æ¸ˆï¼š${done}</div>
          </div>
          <div class="right">
            <button class="btn small primary">é–‹ã</button>
          </div>
        </div>
      `;
      item.querySelector("button").onclick = () => app.openPrecinct(area);
      el.appendChild(item);
    }
  },

  openPrecinct(area){
    store.current_area = area;
    document.getElementById("precinctDetail").style.display = "block";

    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    const total = pts.length;
    const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;
    const modeLabel = (store.travel_mode === "walking") ? "å¾’æ­©" : "è»Š";
    document.getElementById("precTitle").textContent = `${area}ï¼ˆæŠ•ç¥¨åŒºï¼‰`;
    document.getElementById("precSub").textContent = `åœ°ç‚¹æ•°ï¼š${total} / æœªè¨ªå•ï¼š${todo} / ç§»å‹•æ‰‹æ®µï¼š${modeLabel}`;

    // map + gps
    document.getElementById("mapWrap").style.display = "block";
    mapUI.render(area);
    startGpsWatch_();

    app.renderPointList();
    window.scrollTo({top:0, behavior:"smooth"});
  },

  closePrecinct(){
    store.current_area = "";
    document.getElementById("precinctDetail").style.display = "none";
    document.getElementById("mapWrap").style.display = "none";
    // keep gps watch running? â†’ stop to save battery
    stopGpsWatch_();
    app.renderPrecinctList();
  },

  renderPointList(){
    const area = store.current_area;
    const list = document.getElementById("pointList");
    list.innerHTML = "";
    if (!area) return;

    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    for (const p of pts) {
      const st = store.state[p.point_id]?.status || "todo";
      const memo = store.state[p.point_id]?.memo || "";

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">#${p.order_reco} / ${p.point_id} ${statusBadge(st)}</div>
            <div class="itemSub">${(p.name||"").trim()}\n${(p.address||"").trim()}</div>
            ${memo ? `<div class="itemSub">ğŸ“ ${escapeHtml_(memo)}</div>` : ``}
          </div>
          <div class="right">
            <button class="btn small" title="å˜ç‚¹ãƒŠãƒ“">å˜ç‚¹ãƒŠãƒ“</button>
          </div>
        </div>
        <div class="actions">
          <button class="btn small ok" data-act="done">æ¸ˆ</button>
          <button class="btn small" data-act="todo">æœªã«æˆ»ã™</button>
          <button class="btn small ghost" data-act="memo">ãƒ¡ãƒ¢</button>
        </div>
      `;

      item.querySelector(`button[title="å˜ç‚¹ãƒŠãƒ“"]`).onclick = () => app.startSingleNav(p.point_id);
      item.querySelectorAll(`button[data-act]`).forEach(btn=>{
        btn.onclick = () => app.handlePointAction(btn.dataset.act, p.point_id);
      });

      list.appendChild(item);
    }
  },

  getTodoPointsInArea(area){
    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));
    return pts.filter(p => (store.state[p.point_id]?.status || "todo") === "todo");
  },

  async startNavRecommended(){
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }
    const todoPts = app.getTodoPointsInArea(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    await app.startSingleNav(todoPts[0].point_id);
  },

  async pickNextPoint(){
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }
    const todoPts = app.getTodoPointsInArea(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const options = todoPts.slice(0, 30).map(p=>`#${p.order_reco} ${p.point_id} ${(p.name||"").slice(0,18)}`).join("\n");
    const input = prompt("æ¬¡ã«è¡Œãåœ°ç‚¹ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœªè¨ªå•ã‹ã‚‰ï¼‰\n\nå€™è£œï¼ˆå…ˆé ­30ï¼‰:\n" + options, todoPts[0].point_id);
    if (!input) return;

    const pid = input.trim();
    const p = todoPts.find(x=>x.point_id===pid);
    if (!p) { ui.toast("æœªè¨ªå•ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    await app.startSingleNav(p.point_id);
  },

  async startSingleNav(point_id){
    const p = store.points.find(x=>x.point_id===point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

    const url = isIOS()
      ? buildAppleSingleUrl(p.lat, p.lng, store.travel_mode)
      : buildGoogleSingleUrl(p.lat, p.lng, store.travel_mode);

    await postAction({
      action:"nav_start",
      actor_user_id: store.user_id,
      area_id: p.area_id,
      included_point_ids: [p.point_id],
      maps_url: url,
      client_time: new Date().toISOString()
    });

    window.open(url, "_blank");
  },

  async handlePointAction(action, point_id){
    const p = store.points.find(x=>x.point_id===point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

    let status = action;
    let memo = store.state[point_id]?.memo || "";

    if (action === "memo") {
      const m = prompt("ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", memo);
      if (m === null) return;
      memo = m.trim();
      status = store.state[point_id]?.status || "todo";
    } else if (!["todo","done"].includes(action)) {
      ui.toast("æœªå¯¾å¿œã®æ“ä½œã§ã™");
      return;
    }

    const data = await postAction({
      action:"state_update",
      actor_user_id: store.user_id,
      updates: [{
        point_id,
        status,
        memo,
        client_time: new Date().toISOString()
      }]
    });

    if (!data.ok) { ui.toast("æ›´æ–°å¤±æ•—ï¼š" + (data.error||"")); return; }
    const r = (data.results||[]).find(x=>x.point_id===point_id);
    if (r && !r.ok) { ui.toast("æ›´æ–°æ‹’å¦ï¼š" + (r.error||"")); return; }

    store.state[point_id] = { status, memo };
    ui.toast("æ›´æ–°ã—ã¾ã—ãŸ");

    // rerender list + map marker + clustering may change
    app.openPrecinct(p.area_id);
  },

  /** -------- Map filter & GPS controls -------- */
  setMapFilter(mode){
    store.map_filter = mode;
    if (store.current_area) mapUI.render(store.current_area);
  },

  syncFilterButtons_(){
    const all = document.getElementById("btnFilterAll");
    const todo = document.getElementById("btnFilterTodo");
    const done = document.getElementById("btnFilterDone");
    if (!all || !todo || !done) return;

    const onStyle = (btn) => { btn.classList.add("primary"); btn.classList.remove("ghost"); };
    const offStyle = (btn) => { btn.classList.remove("primary"); btn.classList.add("ghost"); };

    // start with all ghost
    [all,todo,done].forEach(offStyle);
    if (store.map_filter === "todo") onStyle(todo);
    else if (store.map_filter === "done") onStyle(done);
    else onStyle(all);
  },

  recenterToMyLocation(){
    if (!mapUI.map) return;
    if (store.my_latlng) {
      mapUI.map.setView([store.my_latlng.lat, store.my_latlng.lng], Math.max(mapUI.map.getZoom(), 16));
      ui.toast("ç¾åœ¨åœ°ã«ç§»å‹•ã—ã¾ã—ãŸ");
      return;
    }
    ui.toast("ç¾åœ¨åœ°ãŒã¾ã å–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
  },

  /** -------- Allocator -------- */
  async loadAllocatorData(){
    const usersResp = await postAction({ action:"alloc_list_users", actor_user_id: store.user_id });
    const assnResp  = await postAction({ action:"alloc_list_assignments", actor_user_id: store.user_id });

    if (!usersResp.ok || !assnResp.ok) {
      ui.toast("å‰²å½“ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ï¼ˆæ¨©é™/è¨­å®šã‚’ç¢ºèªï¼‰");
      store.allUsers = [];
      store.assignments = [];
      app.renderUserCandidates();
      app.renderAssignments();
      return;
    }

    store.allUsers = usersResp.users || [];
    store.assignments = assnResp.assignments || [];
    store.selectedAreas = new Set();
    app.renderUserCandidates();
    app.renderAssignments();
  },

  renderUserCandidates(){
    const q = (document.getElementById("inUserSearch")?.value || "").trim().toLowerCase();
    const el = document.getElementById("userCandidates");
    if (!el) return;
    el.innerHTML = "";

    const list = store.allUsers
      .filter(u => (u.status||"active")==="active")
      .filter(u => (u.role==="field" || u.role==="allocator" || u.role==="planner"))
      .filter(u => !q || (u.display_name||"").toLowerCase().includes(q))
      .slice(0, 8);

    if (list.length === 0) {
      el.innerHTML = `<div class="item"><div class="itemTitle">å€™è£œãªã—</div></div>`;
      return;
    }

    for (const u of list) {
      const item = document.createElement("div");
      item.className = "item";
      const selected = store.selectedAssignee && store.selectedAssignee.user_id === u.user_id;
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${selected ? "âœ… " : ""}${u.display_name}</div>
            <div class="itemSub">role: ${u.role} / user_id: <span class="mono">${u.user_id}</span></div>
          </div>
          <button class="btn small primary">é¸æŠ</button>
        </div>
      `;
      item.querySelector("button").onclick = () => {
        store.selectedAssignee = { user_id: u.user_id, display_name: u.display_name };
        ui.toast("æ‹…å½“è€…ã‚’é¸æŠã—ã¾ã—ãŸ");
        app.renderUserCandidates();
      };
      el.appendChild(item);
    }
  },

  renderAssignments(){
    const el = document.getElementById("assignList");
    if (!el) return;
    el.innerHTML = "";

    const list = (store.assignments || []).slice().sort((a,b)=>String(a.area_id).localeCompare(String(b.area_id)));

    for (const a of list) {
      const area = a.area_id;
      const checked = store.selectedAreas.has(area);
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">
              <input class="checkbox" type="checkbox" ${checked ? "checked":""} />
              <span style="margin-left:8px">${area}</span>
              <span class="badge" style="margin-left:8px">v${a.version}</span>
              <span class="badge" style="margin-left:6px">${a.status}</span>
            </div>
            <div class="itemSub">æ‹…å½“ï¼š${a.assignee_display_name || "ï¼ˆæœªå‰²å½“ï¼‰"}</div>
            <div class="tiny">æ›´æ–°ï¼š${a.updated_at || "-"} / by: ${a.updated_by_name || "-"}</div>
          </div>
        </div>
      `;
      item.querySelector("input").onchange = (e) => {
        if (e.target.checked) store.selectedAreas.add(area);
        else store.selectedAreas.delete(area);
      };
      el.appendChild(item);
    }
  },

  async bulkAssign(){
    if (!store.selectedAssignee) { ui.toast("æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    if (store.selectedAreas.size === 0) { ui.toast("æŠ•ç¥¨åŒºã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    const note = (document.getElementById("inAssignNote").value || "").trim();
    const ops = [];
    for (const area of store.selectedAreas) {
      const a = store.assignments.find(x=>x.area_id===area);
      if (!a) continue;
      ops.push({
        area_id: area,
        action: "assign",
        assignee_user_id: store.selectedAssignee.user_id,
        expected_version: Number(a.version),
        note
      });
    }

    const resp = await postAction({
      action:"alloc_update",
      actor_user_id: store.user_id,
      ops
    });

    if (!resp.ok) { ui.toast("å‰²å½“å¤±æ•—ï¼š" + (resp.error||"")); return; }

    let conflict = 0, ok = 0;
    for (const r of (resp.results||[])) {
      if (r.ok) {
        ok++;
        const a = store.assignments.find(x=>x.area_id===r.area_id);
        if (a) {
          a.version = r.new_version;
          a.status = "assigned";
          a.assignee_user_id = store.selectedAssignee.user_id;
          a.assignee_display_name = store.selectedAssignee.display_name;
          a.updated_at = new Date().toISOString();
          a.updated_by_name = store.display_name;
        }
      } else if (r.error === "CONFLICT") conflict++;
    }

    ui.toast(`å‰²å½“ï¼šæˆåŠŸ${ok} / ç«¶åˆ${conflict}`);
    app.renderAssignments();
  },

  async bulkUnassign(){
    if (store.selectedAreas.size === 0) { ui.toast("æŠ•ç¥¨åŒºã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    const note = (document.getElementById("inAssignNote").value || "").trim();

    const ops = [];
    for (const area of store.selectedAreas) {
      const a = store.assignments.find(x=>x.area_id===area);
      if (!a) continue;
      ops.push({
        area_id: area,
        action: "unassign",
        expected_version: Number(a.version),
        note
      });
    }

    const resp = await postAction({
      action:"alloc_update",
      actor_user_id: store.user_id,
      ops
    });

    if (!resp.ok) { ui.toast("è§£é™¤å¤±æ•—ï¼š" + (resp.error||"")); return; }

    let conflict = 0, ok = 0;
    for (const r of (resp.results||[])) {
      if (r.ok) {
        ok++;
        const a = store.assignments.find(x=>x.area_id===r.area_id);
        if (a) {
          a.version = r.new_version;
          a.status = "unassigned";
          a.assignee_user_id = "";
          a.assignee_display_name = "";
          a.updated_at = new Date().toISOString();
          a.updated_by_name = store.display_name;
        }
      } else if (r.error === "CONFLICT") conflict++;
    }

    ui.toast(`è§£é™¤ï¼šæˆåŠŸ${ok} / ç«¶åˆ${conflict}`);
    app.renderAssignments();
  },

  async allowlistAdd(){
    const nickname = (document.getElementById("alNick").value || "").trim();
    const id_name  = (document.getElementById("alIdName").value || "").trim();
    const note     = (document.getElementById("alNote").value || "").trim();
    if (!nickname || !id_name) { ui.toast("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const resp = await postAction({
      action:"allowlist_add",
      actor_user_id: store.user_id,
      nickname,
      id_name,
      note
    });
    if (!resp.ok) { ui.toast("è¿½åŠ å¤±æ•—ï¼š" + (resp.error||"")); return; }
    ui.toast("è¿½åŠ ã—ã¾ã—ãŸï¼š " + resp.allow_id);
    document.getElementById("alNick").value = "";
    document.getElementById("alIdName").value = "";
    document.getElementById("alNote").value = "";
  },

  async allowlistDisable(){
    const allow_id = (document.getElementById("alDisableId").value || "").trim();
    if (!allow_id) { ui.toast("allow_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    const resp = await postAction({
      action:"allowlist_disable",
      actor_user_id: store.user_id,
      allow_id
    });
    if (!resp.ok) { ui.toast("ç„¡åŠ¹åŒ–å¤±æ•—ï¼š" + (resp.error||"")); return; }
    ui.toast("ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ");
    document.getElementById("alDisableId").value = "";
  },

  bindSettings(){
    const btnSettings = document.getElementById("btnSettings");
    const modal = document.getElementById("settingsModal");
    const btnClose = document.getElementById("btnCloseSettings");
    const btnLogout2 = document.getElementById("btnLogoutInSettings");
    const userBox = document.getElementById("currentUserBox");

    function openSettings(){
      if (store.user_id) userBox.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${store.display_name}ï¼ˆ${store.role}ï¼‰`;
      else userBox.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
      modal.style.display = "block";
    }
    function closeSettings(){ modal.style.display = "none"; }

    btnSettings.addEventListener("click", openSettings);
    btnClose.addEventListener("click", closeSettings);
    modal.addEventListener("click", (e)=>{ if (e.target === modal) closeSettings(); });

    btnLogout2.addEventListener("click", ()=>{
      app.logout();
      closeSettings();
    });
  }
};

window.app = app;
app.init();
</script>
</body>
</html>
