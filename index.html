<!doctype html>
<html lang="ja">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒã‚¹ã‚¿ãƒ¼æ²ç¤ºå ´ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="./tweaks.css">
</head>

<body>
  <div class="topbar">
    <div class="row space">
      <div class="title">ãƒã‚¹ã‚¿ãƒ¼æ²ç¤ºå ´ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</div>
      <div class="row" style="gap:8px">
        <span id="rolePill" class="pill">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
        <button class="btn small ghost" onclick="app.openSettings()">âš™ï¸</button>
      </div>
    </div>

    <div class="row space" style="margin-top:10px">
      <div class="kpi">
        <span class="pill" id="userPill">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-</span>
        <span class="pill" id="modePill">ç§»å‹•ï¼šè»Š</span>
      </div>
      <button class="btn small" onclick="app.reload()">æ›´æ–°</button>
    </div>
  </div>

  <div class="toast" id="toast"><div class="card"><div id="toastText"></div></div></div>

  <div class="wrap">

    <!-- AUTH / REGISTER -->
    <div id="authView" class="card" style="display:none">
      <div class="h2">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆå›ç™»éŒ²ï¼‰</div>
      <div class="muted" style="font-size:15px;line-height:1.55">
        ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨è­˜åˆ¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        è­˜åˆ¥åã¯ã€LINEè¡¨ç¤ºåãŒã‚ã‚‹æ–¹ã¯ãã®è¡¨ç¤ºåã€‚LINEãŒãªã„æ–¹ã¯ãƒ¡ãƒ³ãƒãƒ¼ãŒè­˜åˆ¥ã§ãã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      </div>

      <div style="margin-top:14px">
        <div class="h3">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰</div>
        <input id="inNick" class="field" placeholder="ä¾‹ï¼šã‚‚ã¨ / Aç­ç”°ä¸­" />
      </div>
      <div style="margin-top:12px">
        <div class="h3">è­˜åˆ¥åï¼ˆå¿…é ˆï¼‰</div>
        <input id="inIdName" class="field" placeholder="ä¾‹ï¼šMoto3 / Aç­ ç”°ä¸­" />
      </div>

      <div class="sep"></div>
      <button class="btn primary block" onclick="app.register()">ãƒ­ã‚°ã‚¤ãƒ³</button>

      <div class="tiny" style="margin-top:12px">
        ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„å ´åˆï¼šè²¬ä»»è€…ã«ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã¨ã€Œè­˜åˆ¥åã€ã‚’ä¼ãˆã¦ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç™»éŒ²ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚<br>
        ç®¡ç†è€…ãŒäº‹å‰ã«ç™»éŒ²ã—ãŸãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã®ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã¨ã€Œè­˜åˆ¥åã€ã«å®Œå…¨ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
      </div>
    </div>

    <!-- FIELD -->
    <div id="fieldView" style="display:none">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">æ‹…å½“æŠ•ç¥¨åŒºï¼ˆ1ã€œ97ï¼‰</div>
            <div class="muted" style="font-size:15px">å‰²å½“ã•ã‚ŒãŸæŠ•ç¥¨åŒºã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
          </div>
          <button class="btn small" onclick="app.openTravelModePicker()">ç§»å‹•æ‰‹æ®µ</button>
        </div>

        <div class="sep"></div>
        <div id="precinctList" class="list"></div>
      </div>

      <!-- Precinct Detail -->
      <div id="precinctDetail" class="card" style="display:none">
        <div class="row space">
          <div>
            <div class="h2" id="precTitle">æŠ•ç¥¨åŒº</div>
            <div class="muted" id="precSub" style="font-size:15px"></div>
          </div>
          <button class="btn small ghost" onclick="app.closePrecinct()">æˆ»ã‚‹</button>
        </div>

        <!-- Map (Leaflet) only here -->
        <div id="mapWrap" style="margin-top:12px">
          <div id="map"></div>
          <div class="mapHint">
            åœ°å›³ã®ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®åœ°ç‚¹ã®æ“ä½œãŒã§ãã¾ã™ï¼ˆå˜ç‚¹ãƒŠãƒ“ï¼æ¸ˆï¼æœªã«æˆ»ã™ï¼ãƒ¡ãƒ¢ï¼‰ã€‚
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <button class="btn primary block" onclick="app.startNavRecommended()">æ¬¡ã®1åœ°ç‚¹ãƒŠãƒ“ï¼ˆæœªã®å…ˆé ­ï¼‰</button>
          <button class="btn block" onclick="app.pickNextPoint()">æ¬¡ç‚¹ã‚’é¸ã¶</button>
        </div>

        <div class="tiny" style="margin-top:10px">
          ãƒ«ãƒ¼ãƒ«ï¼šæœªè¨ªå•(todo)ã®ã¿ãƒ»è¨­ç½®ç•ªå·é †ã€‚<br>
          iPhoneã§Googleãƒãƒƒãƒ—ãŒãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€æœ¬ç”»é¢ã§ã¯ã€Œå˜ç‚¹ãƒŠãƒ“ã€ã‚’åŸºæœ¬ã«ã—ã¦ã„ã¾ã™ï¼ˆåœ°å›³ã§é¸ã³ã‚„ã™ã„é‹ç”¨ï¼‰ã€‚
        </div>

        <div class="sep"></div>
        <div id="pointList" class="list"></div>
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="sumView" style="display:none">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">é›†è¨ˆï¼ˆå…¨ä½“ï¼‰</div>
            <div class="tiny">æŠ•ç¥¨åŒºã¨çŠ¶æ…‹ï¼ˆæœª/æ¸ˆï¼‰ã§çµã‚Šè¾¼ã¿ï¼ˆANDï¼‰ã§ãã¾ã™ã€‚ãƒ¡ãƒ¢ã‚‚è¡¨ç¤ºã—ã¾ã™ã€‚</div>
          </div>
          <button class="btn small" onclick="app.loadSummary()">å†èª­è¾¼</button>
        </div>

        <div class="sep"></div>

        <div class="h3">çµã‚Šè¾¼ã¿</div>
        <div class="grid2">
          <div>
            <div class="tiny" style="margin-bottom:6px">æŠ•ç¥¨åŒº</div>
            <select id="sumArea" class="field" onchange="app.renderSummary()">
              <option value="">ï¼ˆå…¨æŠ•ç¥¨åŒºï¼‰</option>
            </select>
          </div>
          <div>
            <div class="tiny" style="margin-bottom:6px">çŠ¶æ…‹ï¼ˆANDï¼‰</div>
            <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:2px">
              <label class="pill" style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="sumTodo" checked />
                æœª
              </label>
              <label class="pill" style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="sumDone" checked />
                æ¸ˆ
              </label>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row space">
          <div class="kpi">
            <span class="pill" id="sumKpiTotal">ç·æ•°ï¼š-</span>
            <span class="pill" id="sumKpiTodo">æœªï¼š-</span>
            <span class="pill" id="sumKpiDone">æ¸ˆï¼š-</span>
          </div>
        </div>

        <div class="sep"></div>

        <div id="sumList" class="list"></div>

        <div class="tiny" style="margin-top:12px">
          â€»é›†è¨ˆã¯GASå´ã« <span class="mono">action:"summary_get"</span> ãŒå¿…è¦ã§ã™ï¼ˆæœªå®Ÿè£…ã®å ´åˆã¯ã€Œæœªå¯¾å¿œã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰ã€‚
        </div>
      </div>
    </div>

    <!-- ALLOCATOR -->
    <div id="allocView" style="display:none">
      <div class="card">
        <div class="row space">
          <div class="h2" style="margin:0">è²¬ä»»è€…</div>
          <div class="right" style="flex-wrap:wrap">
            <button class="btn small primary" id="btnAllocSubAssign" onclick="app.switchAllocSub('assign')">å‰²å½“</button>
            <button class="btn small ghost" id="btnAllocSubAllow" onclick="app.switchAllocSub('allow')">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ</button>
          </div>
        </div>
        <div class="muted" style="margin-top:10px">
          ã€Œå‰²å½“ã€ã¨ã€Œãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã€ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚
        </div>
      </div>
      <div class="card" id="allocAssignSection">
        <div class="h2">å‰²å½“</div>
        <div class="tiny">
          è¤‡æ•°äººåŒæ™‚æ“ä½œã‚’æƒ³å®šã—ã€æŠ•ç¥¨åŒºã”ã¨ã« version ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ç«¶åˆã—ãŸå ´åˆã¯ã€Œç«¶åˆã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆæ›´æ–°ã—ã¦ã‚„ã‚Šç›´ã—ï¼‰ã€‚
        </div>
        <div class="sep"></div>

        <div class="h3">æ‹…å½“è€…æ¤œç´¢ï¼ˆusersï¼‰</div>
        <input id="inUserSearch" class="field" placeholder="è¡¨ç¤ºåã§æ¤œç´¢ï¼ˆä¾‹ï¼šãŸãªã‹ï¼‰" oninput="app.renderUserCandidates()" />
        <div id="userCandidates" class="list" style="margin-top:12px"></div>

        <div class="sep"></div>

        <div class="h3">æŠ•ç¥¨åŒºä¸€è¦§ï¼ˆ97ï¼‰</div>
        <div class="tiny" style="margin-bottom:10px">è¤‡æ•°é¸æŠã—ã¦ä¸€æ‹¬å‰²å½“ã§ãã¾ã™ã€‚</div>

        <div class="grid2">
          <button class="btn primary block" onclick="app.bulkAssign()">é¸æŠã‚’å‰²å½“</button>
          <button class="btn block" style="background:rgba(255,92,92,.18);border:1px solid rgba(255,92,92,.35)" onclick="app.bulkUnassign()">é¸æŠã‚’è§£é™¤</button>
        </div>

        <div style="margin-top:12px">
          <input id="inAssignNote" class="field" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šåˆå‰æ‹…å½“/å¼•ãç¶™ãç­‰ï¼‰" />
        </div>

        <div class="sep"></div>
        <div id="assignList" class="list"></div>
      </div>

      <div class="card" id="allocAllowSection" style="display:none">
        <div class="h2">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼ˆallowlistï¼‰</div>
        <div class="tiny">ç¾å ´ã‹ã‚‰é€£çµ¡ãŒæ¥ãŸã‚‰ã€ãã®å ´ã§ç™»éŒ²ã§ãã¾ã™ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã€‚</div>

        <div class="sep"></div>

        <div class="h3">è¿½åŠ </div>
        <div class="grid2">
          <input id="alNick" class="field" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰" />
          <input id="alIdName" class="field" placeholder="è­˜åˆ¥åï¼ˆå¿…é ˆï¼‰" />
        </div>
        <div style="margin-top:12px">
          <input id="alNote" class="field" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šç­/ç‰¹å¾´/é›»è©±æœ«å°¾ç­‰ï¼‰" />
        </div>
        <div style="margin-top:12px">
          <button class="btn primary block" onclick="app.allowlistAdd()">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        </div>

        <div class="sep"></div>

        <div class="h3">ç„¡åŠ¹åŒ–</div>
        <input id="alDisableId" class="field" placeholder="allow_idï¼ˆä¾‹ï¼šal_000123ï¼‰" />
        <div style="margin-top:12px">
          <button class="btn block" style="background:rgba(255,92,92,.18);border:1px solid rgba(255,92,92,.35)" onclick="app.allowlistDisable()">ã“ã® allow_id ã‚’ç„¡åŠ¹åŒ–</button>
        </div>

        <div class="tiny" style="margin-top:12px">
          â€» allowlist ã®ä¸€è¦§è¡¨ç¤ºã¯çœç•¥ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦ãªã‚‰è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚
        </div>
      </div>
    </div>

  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabs" style="display:none">
    <div class="tab active" id="tabField" onclick="app.switchTab('field')">ç¾å ´</div>
    <div class="tab" id="tabSum" onclick="app.switchTab('sum')">é›†è¨ˆ</div>
    <div class="tab" id="tabAlloc" onclick="app.switchTab('alloc')">è²¬ä»»è€…</div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.40); z-index:1001;">
    <div style="background:var(--card); border:1px solid rgba(255,255,255,.12); color:var(--text);
                margin:12vh auto; padding:16px; width:min(92vw,460px); border-radius:18px;">
      <div class="row space">
        <div class="h2" style="margin:0;">è¨­å®š</div>
        <button class="btn small ghost" onclick="app.closeSettings()">âœ•</button>
      </div>

      <div class="sep"></div>
      <div id="currentUserBox" class="muted"></div>

      <div class="sep"></div>

      <button class="btn block" style="background:rgba(255,92,92,.18);border:1px solid rgba(255,92,92,.35)" onclick="app.logout()">
        ã“ã®ç«¯æœ«ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>

      <div class="tiny" style="margin-top:12px">
        â€»ç«¯æœ«ã‚’ä»–ã®äººã¨å…±ç”¨ã™ã‚‹å ´åˆã®ã¿ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚é€šå¸¸ã¯ä¸è¦ã§ã™ã€‚
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG
 * ========================= */
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwI0SzqbR2IXwyiKOuAbywZYQ2zLDIbBi1K2bt8XU2tib2fJwjez5cKRGi4NVksyGY_pg/exec";

/** =========================
 *  STATE
 * ========================= */
const store = {
  user_id: localStorage.getItem("user_id") || "",
  display_name: localStorage.getItem("display_name") || "",
  role: localStorage.getItem("role") || "",
  travel_mode: localStorage.getItem("travel_mode") || "driving", // driving|walking
  assigned_areas: [],
  points: [],
  state: {}, // point_id -> {status,memo}
  current_area: "",

  // allocator caches
  allUsers: [],
  assignments: [],
  selectedAssignee: null,
  selectedAreas: new Set(),

  // map
  map: null,
  mapMarkers: [],
  mapArea: "",

  // summary cache
  summary: { ok:false, points:[], state:{} }
};

function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

const ui = {
  toast: (msg) => {
    const t = document.getElementById("toast");
    const tx = document.getElementById("toastText");
    tx.innerHTML = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2400);
  },
  setTop: () => {
    document.getElementById("userPill").textContent = store.display_name ? `ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${store.display_name}` : "ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-";
    const modeLabel = store.travel_mode === "walking" ? "å¾’æ­©" : "è»Š";
    document.getElementById("modePill").textContent = `ç§»å‹•ï¼š${modeLabel}`;
    document.getElementById("rolePill").textContent = store.role ? `role: ${store.role}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
  }
};

/** =========================
 *  HTTP
 * ========================= */
async function postAction(payload) {
  if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes("YOUR_GAS_WEBAPP_URL_HERE")) {
    ui.toast("GAS_WEBAPP_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    throw new Error("Missing GAS_WEBAPP_URL");
  }
  const res = await fetch(GAS_WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" }, // preflightå›é¿
    body: JSON.stringify(payload),
  });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error("Bad JSON response: " + text.slice(0,200)); }
  return data;
}

/** =========================
 *  SAFE HTML
 * ========================= */
function escapeHtml_(s){
  s = String(s ?? "");
  return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

/** =========================
 *  MAP URLS
 * ========================= */
function encodeLoc(lat,lng){
  return `${Number(lat).toFixed(7)},${Number(lng).toFixed(7)}`;
}

// å˜ç‚¹ãƒŠãƒ“ï¼šiPhoneã¯Apple Mapã¸ï¼ˆè¦æ±‚é€šã‚Šï¼‰
// - driving: dirflg=d
// - walking: dirflg=w
function buildSingleNavUrl(lat,lng, travelMode){
  const t = (travelMode === "walking") ? "w" : "d";
  if (isIOS()) {
    return `https://maps.apple.com/?daddr=${encodeURIComponent(encodeLoc(lat,lng))}&dirflg=${t}`;
  }
  // Android/PC: Google Maps
  return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(encodeLoc(lat,lng))}&travelmode=${encodeURIComponent(travelMode||"driving")}`;
}

function openNavInNewTab(url){
  const a = document.createElement("a");
  a.href = url;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/** =========================
 *  LEAFLET ICON
 * ========================= */
function markerIcon_(status){
  const cls = (status === "done") ? "done" : "todo";
  return L.divIcon({
    className: "",
    html: `<div class="leaf-dot-wrap"><div class="leaf-dot ${cls}"></div></div>`,
    iconSize: [16,16],
    iconAnchor: [8,8],
    popupAnchor: [0,-8],
  });
}

/** =========================
 *  BADGE
 * ========================= */
function statusBadge(status){
  if (status === "done") return `<span class="badge bDone">æ¸ˆ</span>`;
  return `<span class="badge bTodo">æœª</span>`;
}

/** =========================
 *  APP
 * ========================= */
const app = {
  async init(){
    ui.setTop();
    // summary filter events
    setTimeout(()=>{
      document.getElementById("sumTodo")?.addEventListener("change", ()=>app.renderSummary());
      document.getElementById("sumDone")?.addEventListener("change", ()=>app.renderSummary());
    }, 0);

    if (!store.user_id) {
      app.showAuth();
      return;
    }
    await app.bootstrap();
  },

  showAuth(){
    document.getElementById("authView").style.display = "block";
    document.getElementById("fieldView").style.display = "none";
    document.getElementById("sumView").style.display = "none";
    document.getElementById("allocView").style.display = "none";
    document.getElementById("tabs").style.display = "none";
  },

  async register(){
    const nickname = document.getElementById("inNick").value.trim();
    const id_name  = document.getElementById("inIdName").value.trim();
    if (!nickname || !id_name) { ui.toast("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    ui.toast("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
    const data = await postAction({ action:"register", nickname, id_name });
    if (!data.ok) {
      if (data.error === "NOT_ALLOWED") ui.toast("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæœªç™»éŒ²ï¼‰");
      else ui.toast("å¤±æ•—ï¼š" + (data.error || "ä¸æ˜"));
      return;
    }

    store.user_id = data.user.user_id;
    store.display_name = data.user.display_name;
    store.role = data.user.role;

    localStorage.setItem("user_id", store.user_id);
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);
    localStorage.setItem("travel_mode", store.travel_mode);

    ui.setTop();
    await app.bootstrap();
  },

  async bootstrap(){
    ui.toast("èª­ã¿è¾¼ã¿ä¸­â€¦");
    const data = await postAction({ action:"bootstrap", user_id: store.user_id });
    if (!data.ok) {
      ui.toast("èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™");
      app.logout();
      return;
    }

    store.display_name = data.user.display_name || store.display_name;
    store.role = data.user.role || store.role;
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);

    store.assigned_areas = data.assigned_areas || [];
    store.points = data.points || [];
    store.state = data.state || {};

    ui.setTop();

    // tabs
    document.getElementById("tabs").style.display = "flex";
    const canAlloc = (store.role === "allocator" || store.role === "planner");
    document.getElementById("tabAlloc").style.display = canAlloc ? "block" : "none";

    // default
    app.switchTab("field");
    app.renderPrecinctList();
  },

  async reload(){
    if (!store.user_id) { app.showAuth(); return; }
    await app.bootstrap();
    if (document.getElementById("tabSum").classList.contains("active")) {
      await app.loadSummary();
    }
    if ((store.role === "allocator" || store.role === "planner") && document.getElementById("tabAlloc").classList.contains("active")) {
      await app.loadAllocatorData();
    }
  },

  logout(){
    localStorage.removeItem("user_id");
    localStorage.removeItem("display_name");
    localStorage.removeItem("role");
    // travel_mode stays
    store.user_id = "";
    store.display_name = "";
    store.role = "";
    store.assigned_areas = [];
    store.points = [];
    store.state = {};
    store.current_area = "";
    store.summary = { ok:false, points:[], state:{} };
    ui.setTop();
    app.closeSettings();
    app.showAuth();
  },

  switchTab(which){
    document.getElementById("tabField").classList.toggle("active", which==="field");
    document.getElementById("tabSum").classList.toggle("active", which==="sum");
    document.getElementById("tabAlloc").classList.toggle("active", which==="alloc");

    document.getElementById("fieldView").style.display = which==="field" ? "block" : "none";
    document.getElementById("sumView").style.display = which==="sum" ? "block" : "none";
    document.getElementById("allocView").style.display = which==="alloc" ? "block" : "none";
    document.getElementById("authView").style.display = "none";

    if (which==="sum") {
      app.loadSummary().catch(err => ui.toast("é›†è¨ˆå–å¾—ã«å¤±æ•—ï¼š" + err.message));
    }

    if (which === "alloc") {
      if (!(store.role === "allocator" || store.role === "planner")) {
        ui.toast("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
        app.switchTab("field");
        return;
      }
      app.switchAllocSub("assign"); // â˜…è¿½åŠ 
      app.loadAllocatorData().catch(err => ui.toast("å‰²å½“ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ï¼š" + err.message));
    }
  },

  // è²¬ä»»è€…ã‚¿ãƒ–å†…ã®ã‚µãƒ–ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆå‰²å½“ / ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼‰
  switchAllocSub(which) {
    const isAssign = (which === "assign");

    const secAssign = document.getElementById("allocAssignSection");
    const secAllow = document.getElementById("allocAllowSection");
    const btnAssign = document.getElementById("btnAllocSubAssign");
    const btnAllow = document.getElementById("btnAllocSubAllow");

    if (secAssign) secAssign.style.display = isAssign ? "block" : "none";
    if (secAllow) secAllow.style.display = isAssign ? "none" : "block";

    // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ï¼ˆprimary / ghost ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ï¼‰
    if (btnAssign && btnAllow) {
      btnAssign.classList.toggle("primary", isAssign);
      btnAssign.classList.toggle("ghost", !isAssign);
      btnAllow.classList.toggle("primary", !isAssign);
      btnAllow.classList.toggle("ghost", isAssign);
    }

    // åˆ‡æ›¿æ™‚ã«ä¸Šã¸ï¼ˆé•·ã„ãƒªã‚¹ãƒˆã§è¿·å­é˜²æ­¢ï¼‰
    window.scrollTo({ top: 0, behavior: "smooth" });
  },

  openSettings(){
    const box = document.getElementById("currentUserBox");
    box.textContent = store.user_id ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${store.display_name}ï¼ˆ${store.role}ï¼‰` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
    document.getElementById("settingsModal").style.display = "block";
  },
  closeSettings(){
    document.getElementById("settingsModal").style.display = "none";
  },

  openTravelModePicker(){
    const current = store.travel_mode;
    const msg = `ç§»å‹•æ‰‹æ®µã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆD=è»Š / W=å¾’æ­©ï¼‰\n\n` +
                `${current==="driving"?"â—":"â—‹"} D è»Š\n` +
                `${current==="walking"?"â—":"â—‹"} W å¾’æ­©`;
    const chosen = prompt(msg, current==="walking" ? "W" : "D");
    if (!chosen) return;
    const v = chosen.trim().toUpperCase();
    if (!["D","W"].includes(v)) { ui.toast("å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); return; }
    store.travel_mode = (v==="W") ? "walking" : "driving";
    localStorage.setItem("travel_mode", store.travel_mode);
    ui.setTop();
    ui.toast("ç§»å‹•æ‰‹æ®µã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
  },

  /** -------- Field: precinct list/detail -------- */
  renderPrecinctList(){
    const el = document.getElementById("precinctList");
    el.innerHTML = "";

    if (!store.assigned_areas || store.assigned_areas.length === 0) {
      el.innerHTML = `
        <div class="item">
          <div style="font-weight:1000;font-size:16px">å‰²å½“ãªã—</div>
          <div class="tiny">è²¬ä»»è€…ãŒæŠ•ç¥¨åŒºã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¾ã§ã€ã“ã“ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
        </div>`;
      return;
    }

    const pointsByArea = new Map();
    for (const p of store.points) {
      if (!pointsByArea.has(p.area_id)) pointsByArea.set(p.area_id, []);
      pointsByArea.get(p.area_id).push(p);
    }

    const sortedAreas = store.assigned_areas.slice().sort();
    for (const area of sortedAreas) {
      const pts = (pointsByArea.get(area) || []).slice().sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));
      const total = pts.length;
      const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;
      const done = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="done").length;

      const num = area.replace(/^P0*/,""); // P001 -> 1
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div style="font-weight:1000;font-size:18px;line-height:1.25">æŠ•ç¥¨åŒºï¼š${escapeHtml_(num)}</div>
            <div class="tiny">åœ°ç‚¹ï¼š${total} / æœªï¼š${todo} / æ¸ˆï¼š${done}</div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn small primary">é–‹ã</button>
          </div>
        </div>
      `;
      item.querySelector("button").onclick = () => app.openPrecinct(area, { keepScroll:false });
      el.appendChild(item);
    }
  },

  openPrecinct(areaId, opts={}){
    const keepScroll = !!opts.keepScroll;
    const y = window.scrollY;

    store.current_area = areaId;
    document.getElementById("precinctDetail").style.display = "block";

    const pts = store.points
      .filter(p => p.area_id === areaId)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    const total = pts.length;
    const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;
    const done = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="done").length;

    const num = areaId.replace(/^P0*/,"");
    document.getElementById("precTitle").textContent = `æŠ•ç¥¨åŒºï¼š${num}`;
    document.getElementById("precSub").textContent = `åœ°ç‚¹ï¼š${total} / æœªï¼š${todo} / æ¸ˆï¼š${done} / ç§»å‹•ï¼š${store.travel_mode==="walking"?"å¾’æ­©":"è»Š"}`;

    // map
    document.getElementById("mapWrap").style.display = "block";
    app.renderMapForArea_(areaId);

    // list
    app.renderPointList_(areaId);

    if (keepScroll) setTimeout(()=>window.scrollTo({top:y}), 0);
    else window.scrollTo({top:0, behavior:"smooth"});
  },

  closePrecinct(){
    store.current_area = "";
    document.getElementById("precinctDetail").style.display = "none";
    app.renderPrecinctList();
  },

  renderPointList_(areaId){
    const list = document.getElementById("pointList");
    list.innerHTML = "";

    const pts = store.points
      .filter(p => p.area_id === areaId)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    for (const p of pts) {
      const st = store.state[p.point_id]?.status || "todo";
      const memo = store.state[p.point_id]?.memo || "";

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="pointMeta">
          #${p.order_reco} / ${escapeHtml_(p.point_id)} ${statusBadge(st)}
        </div>
        <div class="pointName">${escapeHtml_((p.name||"").trim())}</div>
        <div class="pointAddr">${escapeHtml_((p.address||"").trim())}</div>
        ${memo ? `<div class="pointMemo">ğŸ“ ${escapeHtml_(memo)}</div>` : ``}

        <div class="actions">
          <button class="btn small" data-act="nav">å˜ç‚¹ãƒŠãƒ“</button>
          <button class="btn small done" data-act="done">æ¸ˆ</button>
          <button class="btn small todo" data-act="todo">æœªã«æˆ»ã™</button>
          <button class="btn small memo" data-act="memo">ãƒ¡ãƒ¢</button>
        </div>
      `;

      item.querySelector('[data-act="nav"]').onclick  = () => app.startSingleNav(p.point_id);
      item.querySelector('[data-act="done"]').onclick = () => app.handlePointAction("done", p.point_id);
      item.querySelector('[data-act="todo"]').onclick = () => app.handlePointAction("todo", p.point_id);
      item.querySelector('[data-act="memo"]').onclick = () => app.handlePointAction("memo", p.point_id);

      list.appendChild(item);
    }
  },

  getTodoPointsInArea_(areaId) {
    const pts = store.points
      .filter(p => p.area_id === areaId)
      .slice()
      .sort((a, b) => a.order_reco - b.order_reco || a.point_id.localeCompare(b.point_id));
    return pts.filter(p => (store.state[p.point_id]?.status || "todo") === "todo");
  },

  // è¦ä»¶ï¼šä»Šã¯å˜ç‚¹ã‚’åŸºæœ¬ã«ï¼ˆiPhoneã®Googleãƒ­ã‚°ã‚¤ãƒ³å›é¿ï¼‰
  async startNavRecommended() {
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }
    const todoPts = app.getTodoPointsInArea_(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    // â˜… await ã¯ä»˜ã‘ãªã„ï¼ˆã‚¿ãƒƒãƒ—ç›´å¾Œã®åŒæœŸã‚’å´©ã•ãªã„ï¼‰
    app.startSingleNav(todoPts[0].point_id);
  },

  async pickNextPoint() {
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }
    const todoPts = app.getTodoPointsInArea_(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const options = todoPts.slice(0, 30)
      .map(p => `#${p.order_reco} ${p.point_id} ${(p.name || "").slice(0, 18)}`)
      .join("\n");
    const input = prompt(
      "æ¬¡ã«è¡Œãåœ°ç‚¹ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœªè¨ªå•ã‹ã‚‰ï¼‰\n\nå€™è£œï¼ˆå…ˆé ­30ï¼‰:\n" + options,
      todoPts[0].point_id
    );
    if (!input) return;

    const pid = input.trim();
    const hit = todoPts.find(p => p.point_id === pid);
    if (!hit) { ui.toast("æœªè¨ªå•ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    // â˜… await ã¯ä»˜ã‘ãªã„
    app.startSingleNav(pid);
  },

  async startSingleNav(point_id) {
    const p = store.points.find(x => x.point_id === point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

    const url = buildSingleNavUrl(p.lat, p.lng, store.travel_mode);

    // â˜… å…ˆã«é–‹ãï¼ˆiPhoneå¯¾ç­–ã®æ ¸å¿ƒï¼‰
    openNavInNewTab(url);

    // â˜… ãƒ­ã‚°ã¯å¾Œã§æŠ•ã’ã‚‹ï¼ˆawaitã—ãªã„ï¼‰
    postAction({
      action: "nav_start",
      actor_user_id: store.user_id,
      area_id: p.area_id,
      included_point_ids: [p.point_id],
      maps_url: url,
      client_time: new Date().toISOString()
    }).catch(() => { /* non-fatal */ });
  },

  async handlePointAction(action, point_id){
    const p = store.points.find(x=>x.point_id===point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

    let status = action;
    let memo = store.state[point_id]?.memo || "";

    if (action === "memo") {
      const m = prompt("ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", memo);
      if (m === null) return;
      memo = m.trim();
      status = store.state[point_id]?.status || "todo";
    }

    const data = await postAction({
      action:"state_update",
      actor_user_id: store.user_id,
      updates: [{
        point_id,
        status,
        memo,
        client_time: new Date().toISOString()
      }]
    });

    if (!data.ok) { ui.toast("æ›´æ–°å¤±æ•—ï¼š" + (data.error||"")); return; }

    const r = (data.results||[]).find(x=>x.point_id===point_id);
    if (r && !r.ok) { ui.toast("æ›´æ–°æ‹’å¦ï¼š" + (r.error||"")); return; }

    // local state
    store.state[point_id] = { status, memo };

    // âœ… 2) æ ¹æœ¬å¯¾ç­–ï¼šãƒˆãƒƒãƒ—ã¸æˆ»ã•ãªã„ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰
    // - æŠ•ç¥¨åŒºç”»é¢ã®ã¾ã¾ã€ãƒªã‚¹ãƒˆã¨åœ°å›³ã ã‘æ›´æ–°
    const area = p.area_id;
    app.renderPointList_(area);
    app.updateMapMarker_(point_id);

    // KPIè¡Œã‚‚æ›´æ–°ã—ãŸã„ã®ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚µãƒ–ã‚’æ›´æ–°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¿æŒï¼‰
    if (store.current_area === area) app.openPrecinct(area, { keepScroll:true });

    ui.toast("æ›´æ–°ã—ã¾ã—ãŸ");
  },

  /** -------- Leaflet map -------- */
  clearMap_(){
    if (!store.map) return;
    for (const mk of store.mapMarkers) {
      try { store.map.removeLayer(mk); } catch(e){}
    }
    store.mapMarkers = [];
  },

  renderMapForArea_(areaId){
    const pts = store.points
      .filter(p => p.area_id === areaId)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    if (!store.map) {
      store.map = L.map("map", { zoomControl:true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(store.map);
    }

    if (store.mapArea !== areaId) {
      store.mapArea = areaId;
    }

    app.clearMap_();

    if (pts.length === 0) {
      store.map.setView([35.0, 139.0], 12);
      return;
    }

    // bounds
    const latlngs = [];
    for (const p of pts) {
      const lat = Number(p.lat), lng = Number(p.lng);
      if (!isFinite(lat) || !isFinite(lng)) continue;
      latlngs.push([lat,lng]);
    }

    for (const p of pts) {
      const lat = Number(p.lat), lng = Number(p.lng);
      if (!isFinite(lat) || !isFinite(lng)) continue;

      const pid = p.point_id;
      const st = store.state[pid]?.status || "todo";

      const mk = L.marker([lat,lng], { icon: markerIcon_(st) }).addTo(store.map);
      mk.__pid = pid;

      const badge = (st === "done") ? "æ¸ˆ" : "æœª";
      mk.bindPopup(`
        <div style="min-width:220px">
          <div style="font-weight:1000;font-size:16px;line-height:1.25">
            #${p.order_reco} / ${escapeHtml_(pid)}ï¼ˆ${badge}ï¼‰
          </div>
          <div style="margin-top:8px;font-size:14px;opacity:.92">${escapeHtml_((p.name||"").trim())}</div>
          <div style="margin-top:6px;font-size:13px;opacity:.75;white-space:pre-wrap">${escapeHtml_((p.address||"").trim())}</div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small" data-mk="nav"  data-pid="${escapeHtml_(pid)}">å˜ç‚¹ãƒŠãƒ“</button>
            <button class="btn small done" data-mk="done" data-pid="${escapeHtml_(pid)}">æ¸ˆ</button>
            <button class="btn small todo" data-mk="todo" data-pid="${escapeHtml_(pid)}">æœª</button>
            <button class="btn small memo" data-mk="memo" data-pid="${escapeHtml_(pid)}">ãƒ¡ãƒ¢</button>
          </div>
        </div>
      `);

      mk.on("popupopen", (ev) => {
        const root = ev.popup.getElement();
        if (!root) return;
        const pid2 = root.querySelector("[data-pid]")?.getAttribute("data-pid");
        if (!pid2) return;

        root.querySelector('[data-mk="nav"]')?.addEventListener("click", () => app.startSingleNav(pid2));
        root.querySelector('[data-mk="done"]')?.addEventListener("click", () => app.handlePointAction("done", pid2));
        root.querySelector('[data-mk="todo"]')?.addEventListener("click", () => app.handlePointAction("todo", pid2));
        root.querySelector('[data-mk="memo"]')?.addEventListener("click", () => app.handlePointAction("memo", pid2));
      });

      store.mapMarkers.push(mk);
    }

    // fit
    if (latlngs.length >= 2) store.map.fitBounds(latlngs, { padding:[20,20] });
    else store.map.setView(latlngs[0], 16);
  },

  updateMapMarker_(point_id){
    // è»½é‡ï¼šè©²å½“ãƒ”ãƒ³ã ã‘è‰²ã‚’æ›´æ–°ï¼ˆdivIconå·®ã—æ›¿ãˆï¼‰
    for (const mk of store.mapMarkers) {
      if (mk.__pid === point_id) {
        const st = store.state[point_id]?.status || "todo";
        mk.setIcon(markerIcon_(st));
        break;
      }
    }
  },

  /** -------- Summary -------- */
  async loadSummary(){
    ui.toast("é›†è¨ˆå–å¾—ä¸­â€¦");
    // GASå´ã« action:"summary_get" ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆã¾ã ãªã‚‰æœªå¯¾å¿œè¡¨ç¤ºï¼‰
    const resp = await postAction({ action:"summary_get", actor_user_id: store.user_id });
    if (!resp.ok) {
      const el = document.getElementById("sumList");
      el.innerHTML = `
        <div class="item">
          <div style="font-weight:1000;font-size:16px">é›†è¨ˆã¯æœªå¯¾å¿œ</div>
          <div class="tiny">GASå´ã« action:"summary_get" ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚error=${escapeHtml_(resp.error||"")}</div>
        </div>`;
      return;
    }
    // æƒ³å®šï¼šresp.pointsï¼ˆå…¨pointsï¼‰ + resp.stateï¼ˆå…¨stateï¼‰
    store.summary = {
      ok:true,
      points: resp.points || [],
      state: resp.state || {}
    };

    // area options
    const sel = document.getElementById("sumArea");
    const areas = Array.from(new Set((store.summary.points||[]).map(p=>String(p.area_id||"")))).filter(Boolean).sort();
    const cur = sel.value || "";
    sel.innerHTML = `<option value="">ï¼ˆå…¨æŠ•ç¥¨åŒºï¼‰</option>` + areas.map(a=>{
      const num = a.replace(/^P0*/,"");
      return `<option value="${escapeHtml_(a)}">æŠ•ç¥¨åŒºï¼š${escapeHtml_(num)}</option>`;
    }).join("");
    sel.value = cur;

    app.renderSummary();
    ui.toast("é›†è¨ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  },

  renderSummary(){
    if (!store.summary.ok) return;

    const area = (document.getElementById("sumArea")?.value || "").trim();
    const wantTodo = document.getElementById("sumTodo")?.checked ?? true;
    const wantDone = document.getElementById("sumDone")?.checked ?? true;

    // ANDçµã‚Šè¾¼ã¿ï¼šæŠ•ç¥¨åŒºãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã° areaä¸€è‡´ + ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è‡´
    function matchStatus(st){
      if (wantTodo && wantDone) return true;
      if (!wantTodo && !wantDone) return true; // 0ä»¶ã¯æ‰±ã„ã¥ã‚‰ã„ã®ã§å…¨ä»¶æ‰±ã„
      if (wantTodo && st !== "done") return true;
      if (wantDone && st === "done") return true;
      return false;
    }

    const pts = (store.summary.points || [])
      .map(p => {
        const pid = String(p.point_id||"");
        const st = String(store.summary.state?.[pid]?.status || "todo");
        const memo = String(store.summary.state?.[pid]?.memo || "");
        return { ...p, status: st, memo };
      })
      .filter(p => !area || String(p.area_id) === area)
      .filter(p => matchStatus(String(p.status||"todo")))
      .slice()
      .sort((a,b)=> String(a.area_id).localeCompare(String(b.area_id)) || Number(a.order_reco||0)-Number(b.order_reco||0) || String(a.point_id).localeCompare(String(b.point_id)));

    // KPI
    const all = (store.summary.points||[]).map(p=>{
      const pid=String(p.point_id||"");
      const st=String(store.summary.state?.[pid]?.status||"todo");
      return st;
    });
    const kTotal = all.length;
    const kDone = all.filter(s=>s==="done").length;
    const kTodo = kTotal - kDone;
    document.getElementById("sumKpiTotal").textContent = `ç·æ•°ï¼š${kTotal}`;
    document.getElementById("sumKpiTodo").textContent = `æœªï¼š${kTodo}`;
    document.getElementById("sumKpiDone").textContent = `æ¸ˆï¼š${kDone}`;

    const el = document.getElementById("sumList");
    el.innerHTML = "";

    if (pts.length === 0) {
      el.innerHTML = `<div class="item"><div style="font-weight:1000;font-size:16px">è©²å½“ãªã—</div><div class="tiny">çµã‚Šè¾¼ã¿æ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚</div></div>`;
      return;
    }

    // group by area
    let curArea = "";
    for (const p of pts) {
      const a = String(p.area_id||"");
      if (a !== curArea) {
        curArea = a;
        const num = a.replace(/^P0*/,"");
        const header = document.createElement("div");
        header.className = "item";
        header.innerHTML = `<div style="font-weight:1000;font-size:16px">æŠ•ç¥¨åŒºï¼š${escapeHtml_(num)}</div>`;
        el.appendChild(header);
      }

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="pointMeta">
          #${Number(p.order_reco||0)} / ${escapeHtml_(p.point_id||"")} ${p.status==="done"?`<span class="badge bDone">æ¸ˆ</span>`:`<span class="badge bTodo">æœª</span>`}
        </div>
        <div class="pointName">${escapeHtml_((p.name||"").trim())}</div>
        <div class="pointAddr">${escapeHtml_((p.address||"").trim())}</div>
        ${p.memo ? `<div class="pointMemo">ğŸ“ ${escapeHtml_(p.memo)}</div>` : ``}
      `;
      el.appendChild(item);
    }
  },

  /** -------- Allocator (existing actions expected) -------- */
  async loadAllocatorData(){
    const usersResp = await postAction({ action:"alloc_list_users", actor_user_id: store.user_id });
    const assnResp  = await postAction({ action:"alloc_list_assignments", actor_user_id: store.user_id });

    if (!usersResp.ok || !assnResp.ok) {
      ui.toast("â€»GASã« alloc_list_users / alloc_list_assignments ãŒå¿…è¦ã§ã™");
      store.allUsers = [];
      store.assignments = [];
      app.renderUserCandidates();
      app.renderAssignments();
      return;
    }

    store.allUsers = usersResp.users || [];
    store.assignments = assnResp.assignments || [];
    store.selectedAreas = new Set();
    app.renderUserCandidates();
    app.renderAssignments();
  },

  renderUserCandidates(){
    const q = (document.getElementById("inUserSearch")?.value || "").trim().toLowerCase();
    const el = document.getElementById("userCandidates");
    if (!el) return;
    el.innerHTML = "";

    const list = store.allUsers
      .filter(u => (u.status||"active")==="active")
      .filter(u => (u.role==="field" || u.role==="allocator" || u.role==="planner"))
      .filter(u => !q || (u.display_name||"").toLowerCase().includes(q))
      .slice(0, 10);

    if (list.length === 0) {
      el.innerHTML = `<div class="item"><div style="font-weight:1000;font-size:16px">å€™è£œãªã—</div><div class="tiny">users ã‚’å–å¾—ã§ãã¦ã„ãªã„å ´åˆã¯GASå´ã® action ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div></div>`;
      return;
    }

    for (const u of list) {
      const item = document.createElement("div");
      item.className = "item";
      const selected = store.selectedAssignee && store.selectedAssignee.user_id === u.user_id;
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div style="font-weight:1000;font-size:16px">${selected ? "âœ… " : ""}${escapeHtml_(u.display_name)}</div>
            <div class="tiny">role: ${escapeHtml_(u.role)} / user_id: <span class="mono">${escapeHtml_(u.user_id)}</span></div>
          </div>
          <button class="btn small primary">é¸æŠ</button>
        </div>
      `;
      item.querySelector("button").onclick = () => {
        store.selectedAssignee = { user_id: u.user_id, display_name: u.display_name };
        ui.toast("æ‹…å½“è€…ã‚’é¸æŠã—ã¾ã—ãŸ");
        app.renderUserCandidates();
      };
      el.appendChild(item);
    }
  },

  renderAssignments(){
    const el = document.getElementById("assignList");
    if (!el) return;
    el.innerHTML = "";

    const list = (store.assignments || []).slice().sort((a,b)=>String(a.area_id).localeCompare(String(b.area_id)));
    for (const a of list) {
      const area = String(a.area_id||"");
      const checked = store.selectedAreas.has(area);
      const num = area.replace(/^P0*/,"");
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div style="font-weight:1000;font-size:16px;line-height:1.2">
              <input type="checkbox" ${checked ? "checked":""} />
              <span style="margin-left:8px">æŠ•ç¥¨åŒºï¼š${escapeHtml_(num)}</span>
              <span class="badge" style="margin-left:8px">v${Number(a.version||1)}</span>
              <span class="badge" style="margin-left:6px">${escapeHtml_(a.status||"")}</span>
            </div>
            <div class="tiny">æ‹…å½“ï¼š${escapeHtml_(a.assignee_display_name || "ï¼ˆæœªå‰²å½“ï¼‰")}</div>
          </div>
        </div>
      `;
      item.querySelector("input").onchange = (e) => {
        if (e.target.checked) store.selectedAreas.add(area);
        else store.selectedAreas.delete(area);
      };
      el.appendChild(item);
    }
  },

  async bulkAssign(){
    if (!store.selectedAssignee) { ui.toast("æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    if (store.selectedAreas.size === 0) { ui.toast("æŠ•ç¥¨åŒºã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    const note = (document.getElementById("inAssignNote").value || "").trim();

    const ops = [];
    for (const area of store.selectedAreas) {
      const a = store.assignments.find(x=>String(x.area_id)===String(area));
      if (!a) continue;
      ops.push({
        area_id: area,
        action: "assign",
        assignee_user_id: store.selectedAssignee.user_id,
        expected_version: Number(a.version),
        note
      });
    }

    const resp = await postAction({ action:"alloc_update", actor_user_id: store.user_id, ops });
    if (!resp.ok) { ui.toast("å‰²å½“å¤±æ•—ï¼š" + (resp.error||"")); return; }

    let conflict = 0, ok = 0;
    for (const r of (resp.results||[])) {
      if (r.ok) ok++;
      else if (r.error==="CONFLICT") conflict++;
    }
    ui.toast(`å‰²å½“ï¼šæˆåŠŸ${ok} / ç«¶åˆ${conflict}`);
    await app.loadAllocatorData();
  },

  async bulkUnassign(){
    if (store.selectedAreas.size === 0) { ui.toast("æŠ•ç¥¨åŒºã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    const note = (document.getElementById("inAssignNote").value || "").trim();

    const ops = [];
    for (const area of store.selectedAreas) {
      const a = store.assignments.find(x=>String(x.area_id)===String(area));
      if (!a) continue;
      ops.push({
        area_id: area,
        action: "unassign",
        expected_version: Number(a.version),
        note
      });
    }

    const resp = await postAction({ action:"alloc_update", actor_user_id: store.user_id, ops });
    if (!resp.ok) { ui.toast("è§£é™¤å¤±æ•—ï¼š" + (resp.error||"")); return; }

    let conflict = 0, ok = 0;
    for (const r of (resp.results||[])) {
      if (r.ok) ok++;
      else if (r.error==="CONFLICT") conflict++;
    }
    ui.toast(`è§£é™¤ï¼šæˆåŠŸ${ok} / ç«¶åˆ${conflict}`);
    await app.loadAllocatorData();
  },

  async allowlistAdd(){
    const nickname = (document.getElementById("alNick").value || "").trim();
    const id_name  = (document.getElementById("alIdName").value || "").trim();
    const note     = (document.getElementById("alNote").value || "").trim();
    if (!nickname || !id_name) { ui.toast("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const resp = await postAction({ action:"allowlist_add", actor_user_id: store.user_id, nickname, id_name, note });
    if (!resp.ok) { ui.toast("è¿½åŠ å¤±æ•—ï¼š" + (resp.error||"")); return; }
    ui.toast("è¿½åŠ ã—ã¾ã—ãŸï¼š " + resp.allow_id);
    document.getElementById("alNick").value = "";
    document.getElementById("alIdName").value = "";
    document.getElementById("alNote").value = "";
  },

  async allowlistDisable(){
    const allow_id = (document.getElementById("alDisableId").value || "").trim();
    if (!allow_id) { ui.toast("allow_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    const resp = await postAction({ action:"allowlist_disable", actor_user_id: store.user_id, allow_id });
    if (!resp.ok) { ui.toast("ç„¡åŠ¹åŒ–å¤±æ•—ï¼š" + (resp.error||"")); return; }
    ui.toast("ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ");
    document.getElementById("alDisableId").value = "";
  }
};

window.app = app;
app.init();
</script>

</body>
</html>
