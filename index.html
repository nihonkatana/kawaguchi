<!doctype html>
<html lang="ja">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é¸æŒ™æ²ç¤ºæ¿ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root {
      --bg:#0b0f1a;
      --card:#121a2b;
      --muted:#a7b0c0;
      --text:#eef2ff;
      --accent:#4f8cff;

      /* èª¤èªé˜²æ­¢ï¼šæ¸ˆã¯â€œè½ã¡ç€ã„ãŸç·‘â€ã€æœªã¯â€œå¼·ã‚ã«ç›®ç«‹ã¤é’â€ */
      --done:#1fb56a;
      --done2:#158d53;
      --todo:#3d7cff;

      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:760px;margin:0 auto;padding:18px 14px 100px}
    .topbar{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(to bottom, rgba(11,15,26,.98), rgba(11,15,26,.80));
      backdrop-filter: blur(10px);
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.08)
    }
    .row{display:flex;gap:12px;align-items:center}
    .space{justify-content:space-between}
    .title{font-size:18px;font-weight:900;letter-spacing:.2px}
    .pill{
      font-size:13px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      color:var(--muted)
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:14px 16px;
      font-weight:900;
      font-size:16px;
      background:rgba(255,255,255,.10);
      color:var(--text);
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.16)}
    .btn.small{padding:12px 14px;font-size:15px;border-radius:14px}
    .btn.tiny{padding:10px 12px;font-size:14px;border-radius:12px}
    .btn.block{width:100%}

    /* èª¤èªé˜²æ­¢ï¼šã€æ¸ˆã€ãƒœã‚¿ãƒ³ã¯â€œæ§ãˆã‚â€ã«ï¼ˆæŠ¼ã—ã¦åˆã‚ã¦æ¸ˆã«ãªã‚‹ï¼‰ */
    .btn.done{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(31,181,106,.45);
      color:rgba(201,255,225,.95);
    }
    .btn.todo{
      background:rgba(255,255,255,.10);
    }
    .btn.memo{
      background:rgba(79,140,255,.14);
      border:1px solid rgba(79,140,255,.35);
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      padding:16px;
      margin:14px 0;
      box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .muted{color:var(--muted)}
    .h2{font-size:17px;font-weight:1000;margin:0 0 10px}
    .h3{font-size:14px;font-weight:1000;margin:0 0 8px}

    .sep{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .list{display:flex;flex-direction:column;gap:12px}
    .item{
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05)
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTitle{font-weight:1000;font-size:19px;line-height:1.2}
    .itemSub{font-size:15px;color:rgba(167,176,192,.92);margin-top:6px;white-space:pre-wrap;line-height:1.4}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .right{display:flex;gap:10px;align-items:center}

    .badge{
      display:inline-block;
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .bTodo{
      background:rgba(61,124,255,.18);
      color:#d8e6ff;
      border-color:rgba(61,124,255,.45);
    }
    .bDone{
      background:rgba(31,181,106,.16);
      color:#c9ffe1;
      border-color:rgba(31,181,106,.30);
    }

    /* â€œ#1 / 1-1 æœªâ€ ã‚’ç›®ç«‹ãŸã›ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .pointHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pointMain{
      font-size:22px;
      font-weight:1000;
      letter-spacing:.2px;
      color:rgba(238,242,255,.98);
    }
    .pointMain .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:20px;
      opacity:.98;
    }

    .field{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    .field::placeholder{color:rgba(167,176,192,.7)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:420px){
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
    }

    .tabs{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(18,26,43,.96);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.12);
      padding:12px;
      display:flex;gap:10px;z-index:60
    }
    .tab{
      flex:1;text-align:center;padding:12px 10px;border-radius:14px;
      font-weight:1000;font-size:14px;color:var(--muted);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer
    }
    .tab.active{
      color:var(--text);
      background:rgba(79,140,255,.20);
      border-color:rgba(79,140,255,.50)
    }

    .toast{position:fixed;left:14px;right:14px;top:14px;z-index:100;display:none}
    .toast.show{display:block}
    .toast .card{margin:0}

    /* Leaflet Popupï¼ˆæ¿ƒã„èƒŒæ™¯ï¼‹ç™½æ–‡å­—ï¼‰ */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background: rgba(18,26,43,.98);
      color: var(--text);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    .leaflet-popup-content{ margin:12px 14px; font-size:15px; }
    .leaflet-container a{ color: var(--text); }

    #mapWrap{display:none}
    #map{
      width:100%;
      height:52vh;
      min-height:360px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background:#0b0f1a;
    }

    /* summary */
    .kpiRow{display:flex; gap:10px; flex-wrap:wrap}
    .kpiBox{
      flex:1;
      min-width:140px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
    }
    .kpiBig{font-size:22px;font-weight:1000;margin-top:4px}
    .kpiSmall{font-size:13px;color:rgba(167,176,192,.9)}
    .hint{font-size:13px;color:rgba(167,176,192,.92);line-height:1.45}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="row space">
      <div class="title">é¸æŒ™æ²ç¤ºæ¿ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</div>
      <div class="right">
        <span id="rolePill" class="pill">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
        <button class="btn small ghost" onclick="app.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
    <div class="row space" style="margin-top:10px">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <span class="pill" id="userPill">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-</span>
        <span class="pill" id="modePill">ç§»å‹•ï¼šè»Š</span>
      </div>
      <button class="btn small" onclick="app.reload()">æ›´æ–°</button>
    </div>
  </div>

  <div class="toast" id="toast"><div class="card"><div id="toastText"></div></div></div>

  <div class="wrap">
    <!-- AUTH -->
    <div id="authView" class="card" style="display:none">
      <div class="h2">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆå›ç™»éŒ²ï¼‰</div>
      <div class="muted" style="font-size:14px;line-height:1.6">
        ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨è­˜åˆ¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        è­˜åˆ¥åã¯ã€LINEè¡¨ç¤ºåãŒã‚ã‚‹æ–¹ã¯ãã®è¡¨ç¤ºåã€‚LINEãŒãªã„æ–¹ã¯å‘¨å›²ãŒè­˜åˆ¥ã§ãã‚‹åå‰ï¼ˆç­åï¼‹æ°åãªã©ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      </div>
      <div style="margin-top:12px">
        <div class="h3">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰</div>
        <input id="inNick" class="field" placeholder="ä¾‹ï¼šã”ã¾ã¡ã‚ƒã‚“ / Aç­ç”°ä¸­" />
      </div>
      <div style="margin-top:10px">
        <div class="h3">è­˜åˆ¥åï¼ˆå¿…é ˆï¼‰</div>
        <input id="inIdName" class="field" placeholder="ä¾‹ï¼šæ˜çŸ³å®¶ ã‚´ãƒ / Aç­ ç”°ä¸­" />
      </div>
      <div class="sep"></div>
      <button class="btn primary block" onclick="app.register()">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</button>
      <div class="muted" style="margin-top:10px;font-size:13px;line-height:1.5">
        ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„å ´åˆï¼šè²¬ä»»è€…ã«ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã¨ã€Œè­˜åˆ¥åã€ã‚’ä¼ãˆã¦ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç™»éŒ²ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã€‚
      </div>
    </div>

    <!-- FIELD -->
    <div id="fieldView" style="display:none">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">æ‹…å½“æŠ•ç¥¨åŒº</div>
            <div class="muted" style="font-size:14px">å‰²å½“ã•ã‚ŒãŸæŠ•ç¥¨åŒºï¼ˆ1ã€œ97ï¼‰ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
          </div>
          <button class="btn small" onclick="app.openTravelModePicker()">ç§»å‹•æ‰‹æ®µ</button>
        </div>
        <div class="sep"></div>
        <div id="precinctList" class="list"></div>
      </div>

      <div id="precinctDetail" class="card" style="display:none">
        <div class="row space">
          <div>
            <div class="h2" id="precTitle">æŠ•ç¥¨åŒº</div>
            <div class="muted" id="precSub" style="font-size:15px"></div>
          </div>
          <button class="btn small ghost" onclick="app.closePrecinct()">æˆ»ã‚‹</button>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <button class="btn primary block" onclick="app.startNavRecommended()">æ¨å¥¨ãƒŠãƒ“é–‹å§‹ï¼ˆæœªè¨ªå•ï¼‰</button>
          <button class="btn block" onclick="app.pickNextPoint()">æ¬¡ç‚¹ã‚’é¸ã¶</button>
        </div>

        <div class="muted" style="font-size:13px;margin-top:10px;line-height:1.45">
          ãƒ«ãƒ¼ãƒ«ï¼šæœªè¨ªå•(todo)ã®ã¿ãƒ»è¨­ç½®ç•ªå·é †ã€‚æœ€å¤§8åœ°ç‚¹ã‚’GoogleãƒŠãƒ“ã«æ¸¡ã—ã¾ã™ã€‚<br>
          â€»åœ°å›³ãƒ”ãƒ³ã‹ã‚‰ã€Œå˜ç‚¹ãƒŠãƒ“ï¼†æ¸ˆ/æœª/ãƒ¡ãƒ¢ã€ã‚‚ã§ãã¾ã™ã€‚
        </div>

        <div class="sep"></div>

        <div id="mapWrap">
          <div class="h3">åœ°å›³ï¼ˆãƒ”ãƒ³ã‚’æŠ¼ã—ã¦æ“ä½œï¼‰</div>
          <div class="muted" style="font-size:13px;margin-top:4px">
            ãƒ”ãƒ³è‰²ï¼šæœª=é’ / æ¸ˆ=ç·‘
          </div>
          <div style="margin-top:10px">
            <div id="map"></div>
          </div>
          <div class="sep"></div>
        </div>

        <div id="pointList" class="list"></div>
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="summaryView" style="display:none">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">é›†è¨ˆï¼ˆæœª/æ¸ˆ + ãƒ¡ãƒ¢ï¼‰</div>
            <div class="hint" id="summaryScopeHint">
              èª­ã¿è¾¼ã¿ä¸­â€¦
            </div>
          </div>
          <button class="btn small" onclick="app.summaryReload(true)">æ›´æ–°</button>
        </div>

        <div class="sep"></div>

        <div class="kpiRow">
          <div class="kpiBox">
            <div class="kpiSmall">åˆè¨ˆ</div>
            <div class="kpiBig" id="kpiTotal">-</div>
          </div>
          <div class="kpiBox">
            <div class="kpiSmall">æœª</div>
            <div class="kpiBig" id="kpiTodo">-</div>
          </div>
          <div class="kpiBox">
            <div class="kpiSmall">æ¸ˆ</div>
            <div class="kpiBig" id="kpiDone">-</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="h3">çµã‚Šè¾¼ã¿ï¼ˆANDï¼‰</div>
        <div class="grid2" style="margin-top:8px">
          <select id="sumArea" class="field" onchange="app.renderSummaryList()">
            <option value="">æŠ•ç¥¨åŒºï¼šã™ã¹ã¦</option>
          </select>
          <select id="sumStatus" class="field" onchange="app.renderSummaryList()">
            <option value="">çŠ¶æ…‹ï¼šã™ã¹ã¦</option>
            <option value="todo">æœª</option>
            <option value="done">æ¸ˆ</option>
          </select>
        </div>

        <div class="sep"></div>

        <div class="row space">
          <div class="h3" style="margin:0">ä¸€è¦§</div>
          <div class="muted" id="summaryCount" style="font-size:14px">-</div>
        </div>

        <div id="summaryList" class="list" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ALLOCATORï¼ˆæ¬¡ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ -->
    <div id="allocView" style="display:none">
      <div class="card">
        <div class="h2">å‰²å½“ï¼ˆè²¬ä»»è€…ï¼‰</div>
        <div class="muted" style="font-size:13px;line-height:1.5">
          allocator / planner ã®å‰²å½“UIã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã—ã¾ã™ã€‚é›†è¨ˆã‚¿ãƒ–ã¯å…¨å“¡åˆ©ç”¨ã§ãã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <div class="tabs" id="tabs" style="display:none">
    <div class="tab active" id="tabField" onclick="app.switchTab('field')">ç¾å ´</div>
    <div class="tab" id="tabSummary" onclick="app.switchTab('summary')">é›†è¨ˆ</div>
    <div class="tab" id="tabAlloc" onclick="app.switchTab('alloc')">è²¬ä»»è€…</div>
  </div>

<script>
/** =========================
 *  CONFIG
 * ========================= */
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbymE91ulu4fG8L8WSFVZcuq_VpGfOhszIchpJKLfHo6Gdz0y4iJLYbK0HsYaQofirtGzQ/exec"; // â˜…ã“ã“ã‚’ã‚ãªãŸã® Webã‚¢ãƒ—ãƒªURL ã«ç½®æ›

/** =========================
 *  STATE
 * ========================= */
const store = {
  user_id: localStorage.getItem("user_id") || "",
  display_name: localStorage.getItem("display_name") || "",
  role: localStorage.getItem("role") || "",
  travel_mode: localStorage.getItem("travel_mode") || "driving", // default: driving
  assigned_areas: [],
  points: [],
  state: {},
  current_area: "",

  // leaflet
  map: null,
  mapMarkers: [],
  mapMarkerByPid: {},

  // summary cache
  summary: null, // {scope,kpi,by_area,points}
  summary_loaded_at: 0,
};

/** =========================
 *  UI
 * ========================= */
const ui = {
  toast: (msg) => {
    const t = document.getElementById("toast");
    const tx = document.getElementById("toastText");
    tx.innerHTML = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2400);
  },
  setTop: () => {
    document.getElementById("userPill").textContent = store.display_name ? `ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${store.display_name}` : "ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-";
    const modeLabel = store.travel_mode === "walking" ? "å¾’æ­©" : "è»Š";
    document.getElementById("modePill").textContent = `ç§»å‹•ï¼š${modeLabel}`;
    document.getElementById("rolePill").textContent = store.role ? `role: ${store.role}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
  }
};

/** =========================
 *  HTTP
 * ========================= */
async function postAction(payload) {
  if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes("YOUR_GAS_WEBAPP_URL_HERE")) {
    ui.toast("GAS_WEBAPP_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    throw new Error("Missing GAS_WEBAPP_URL");
  }
  const res = await fetch(GAS_WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" }, // preflightå›é¿
    body: JSON.stringify(payload),
  });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error("Bad JSON response: " + text.slice(0,200)); }
  return data;
}

/** =========================
 *  MAPS URL
 * ========================= */
function encodeLoc(lat,lng){
  return `${Number(lat).toFixed(7)},${Number(lng).toFixed(7)}`;
}
function buildDirUrl(pointsLatLng, travelMode){
  const base = "https://www.google.com/maps/dir/";
  const parts = ["Current+Location", ...pointsLatLng];
  const url = base + parts.join("/") + `?travelmode=${encodeURIComponent(travelMode||"driving")}`;
  return url;
}
function statusBadge(status){
  if (status === "done") return `<span class="badge bDone">æ¸ˆ</span>`;
  return `<span class="badge bTodo">æœª</span>`;
}

/** =========================
 *  APP
 * ========================= */
const app = {
  async init(){
    ui.setTop();
    if (!store.user_id) {
      app.showAuth();
      return;
    }
    await app.bootstrap();
  },

  showAuth(){
    document.getElementById("authView").style.display = "block";
    document.getElementById("fieldView").style.display = "none";
    document.getElementById("allocView").style.display = "none";
    document.getElementById("summaryView").style.display = "none";
    document.getElementById("tabs").style.display = "none";
  },

  async register(){
    const nickname = document.getElementById("inNick").value.trim();
    const id_name  = document.getElementById("inIdName").value.trim();
    if (!nickname || !id_name) { ui.toast("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    ui.toast("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
    const data = await postAction({ action:"register", nickname, id_name });
    if (!data.ok) {
      if (data.error === "NOT_ALLOWED") ui.toast("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæœªç™»éŒ²ï¼‰");
      else ui.toast("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + (data.error || "ä¸æ˜"));
      return;
    }

    store.user_id = data.user.user_id;
    store.display_name = data.user.display_name;
    store.role = data.user.role;

    localStorage.setItem("user_id", store.user_id);
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);
    localStorage.setItem("travel_mode", store.travel_mode);

    ui.setTop();
    await app.bootstrap();
  },

  async bootstrap(){
    ui.toast("èª­ã¿è¾¼ã¿ä¸­â€¦");
    const data = await postAction({ action:"bootstrap", user_id: store.user_id });
    if (!data.ok) {
      ui.toast("èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™");
      app.logout();
      return;
    }

    store.display_name = data.user.display_name || store.display_name;
    store.role = data.user.role || store.role;
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);

    store.assigned_areas = data.assigned_areas || [];
    store.points = data.points || [];
    store.state = data.state || {};

    // bootstrap ã—ãŸã‚‰ summary ã‚’å¤ã„æ‰±ã„ã«ï¼ˆå¿…è¦æ™‚ãƒ­ãƒ¼ãƒ‰ï¼‰
    store.summary = null;
    store.summary_loaded_at = 0;

    ui.setTop();

    const tabs = document.getElementById("tabs");
    tabs.style.display = "flex";
    const canAlloc = (store.role === "allocator" || store.role === "planner");
    document.getElementById("tabAlloc").style.display = canAlloc ? "block" : "none";

    // é›†è¨ˆã‚¿ãƒ–ã¯å…¨å“¡OK
    document.getElementById("tabSummary").style.display = "block";

    app.switchTab("field");
    app.renderPrecinctList();
  },

  async reload(){
    if (!store.user_id) { app.showAuth(); return; }
    await app.bootstrap();
  },

  logout(){
    localStorage.removeItem("user_id");
    localStorage.removeItem("display_name");
    localStorage.removeItem("role");
    // travel_mode stays
    store.user_id = "";
    store.display_name = "";
    store.role = "";
    store.assigned_areas = [];
    store.points = [];
    store.state = {};
    store.current_area = "";
    store.summary = null;
    store.summary_loaded_at = 0;
    ui.setTop();
    app.showAuth();
  },

  switchTab(which){
    document.getElementById("tabField").classList.toggle("active", which==="field");
    document.getElementById("tabSummary").classList.toggle("active", which==="summary");
    document.getElementById("tabAlloc").classList.toggle("active", which==="alloc");

    document.getElementById("fieldView").style.display = which==="field" ? "block" : "none";
    document.getElementById("summaryView").style.display = which==="summary" ? "block" : "none";
    document.getElementById("allocView").style.display = which==="alloc" ? "block" : "none";
    document.getElementById("authView").style.display = "none";

    if (which==="alloc") {
      if (!(store.role === "allocator" || store.role === "planner")) {
        ui.toast("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
        app.switchTab("field");
        return;
      }
    }

    if (which==="summary") {
      // åˆå› or å¤ã„å ´åˆã«ãƒ­ãƒ¼ãƒ‰
      app.summaryReload(false).catch(err => ui.toast("é›†è¨ˆå–å¾—ã«å¤±æ•—ï¼š" + err.message));
    }
  },

  openTravelModePicker(){
    // å…¥åŠ›ã¯ D / W ã«ç°¡ç•¥åŒ–
    const current = store.travel_mode === "walking" ? "W" : "D";
    const chosen = prompt("ç§»å‹•æ‰‹æ®µã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆD=è»Š / W=å¾’æ­©ï¼‰", current);
    if (!chosen) return;
    const v = chosen.trim().toUpperCase();
    if (!["D","W"].includes(v)) { ui.toast("å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); return; }
    store.travel_mode = (v==="W") ? "walking" : "driving";
    localStorage.setItem("travel_mode", store.travel_mode);
    ui.setTop();
    ui.toast("ç§»å‹•æ‰‹æ®µã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
  },

  areaLabel_(areaId){
    const m = String(areaId||"").match(/P(\d+)/i);
    if (!m) return String(areaId||"");
    return String(parseInt(m[1],10));
  },

  /** -------- Field: precinct list/detail -------- */
  renderPrecinctList(){
    const el = document.getElementById("precinctList");
    el.innerHTML = "";

    if (!store.assigned_areas || store.assigned_areas.length === 0) {
      el.innerHTML = `
        <div class="item">
          <div class="itemTitle">å‰²å½“ãªã—</div>
          <div class="itemSub">è²¬ä»»è€…ãŒæŠ•ç¥¨åŒºã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¾ã§ã€ã“ã“ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
        </div>`;
      return;
    }

    const pointsByArea = new Map();
    for (const p of store.points) {
      if (!pointsByArea.has(p.area_id)) pointsByArea.set(p.area_id, []);
      pointsByArea.get(p.area_id).push(p);
    }

    for (const area of store.assigned_areas.slice().sort()) {
      const pts = (pointsByArea.get(area) || []).slice().sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));
      const total = pts.length;
      const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;
      const done = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="done").length;

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">æŠ•ç¥¨åŒºï¼š${app.areaLabel_(area)}</div>
            <div class="itemSub">åœ°ç‚¹ï¼š${total} / æœªï¼š${todo} / æ¸ˆï¼š${done}</div>
          </div>
          <div class="right">
            <button class="btn small primary">é–‹ã</button>
          </div>
        </div>
      `;
      item.querySelector("button").onclick = () => app.openPrecinct(area);
      el.appendChild(item);
    }
  },

  openPrecinct(area){
    store.current_area = area;
    document.getElementById("precinctDetail").style.display = "block";

    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    const total = pts.length;
    const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;

    document.getElementById("precTitle").textContent = `æŠ•ç¥¨åŒºï¼š${app.areaLabel_(area)}`;
    const modeLabel = store.travel_mode === "walking" ? "å¾’æ­©" : "è»Š";
    document.getElementById("precSub").textContent = `åœ°ç‚¹æ•°ï¼š${total} / æœªè¨ªå•ï¼š${todo} / ç§»å‹•ï¼š${modeLabel}`;

    app.renderPointList();
    app.renderMapForArea_(area);
    window.scrollTo({top:0, behavior:"smooth"});
  },

  closePrecinct(){
    store.current_area = "";
    document.getElementById("precinctDetail").style.display = "none";
    document.getElementById("mapWrap").style.display = "none";
    app.renderPrecinctList();
  },

  renderPointList(){
    const area = store.current_area;
    const list = document.getElementById("pointList");
    list.innerHTML = "";
    if (!area) return;

    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    for (const p of pts) {
      const st = store.state[p.point_id]?.status || "todo";
      const memo = store.state[p.point_id]?.memo || "";

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="pointHeader">
          <div class="pointMain">
            <span class="mono">#${p.order_reco}</span> /
            <span class="mono">${p.point_id}</span>
          </div>
          ${statusBadge(st)}
        </div>

        <div class="itemSub">${(p.name||"").trim()}\n${(p.address||"").trim()}</div>
        ${memo ? `<div class="itemSub">ğŸ“ ${memo}</div>` : ``}

        <div class="actions">
          <button class="btn small" data-act="single" data-pid="${p.point_id}">å˜ç‚¹ãƒŠãƒ“</button>
          <button class="btn small done" data-act="done" data-pid="${p.point_id}">${st==="done" ? "æ¸ˆï¼ˆç¾åœ¨ï¼‰" : "æ¸ˆã«ã™ã‚‹"}</button>
          <button class="btn small todo" data-act="todo" data-pid="${p.point_id}">æœªã«æˆ»ã™</button>
          <button class="btn small memo" data-act="memo" data-pid="${p.point_id}">ãƒ¡ãƒ¢</button>
        </div>
      `;

      item.querySelectorAll(`button[data-act]`).forEach(btn=>{
        btn.onclick = () => app.handlePointAction(btn.dataset.act, btn.dataset.pid);
      });

      list.appendChild(item);
    }
  },

  refreshCurrentPrecinct_({ keepScroll, touched_point_id } = {}){
    const area = store.current_area;
    if (!area) return;

    const y = keepScroll ? window.scrollY : 0;

    app.renderPointList();

    const pts = store.points.filter(p=>p.area_id===area);
    const total = pts.length;
    const todo = pts.filter(p => (store.state[p.point_id]?.status || "todo")==="todo").length;
    const modeLabel = store.travel_mode === "walking" ? "å¾’æ­©" : "è»Š";
    document.getElementById("precSub").textContent = `åœ°ç‚¹æ•°ï¼š${total} / æœªè¨ªå•ï¼š${todo} / ç§»å‹•ï¼š${modeLabel}`;

    if (store.mapMarkerByPid && touched_point_id && store.mapMarkerByPid[touched_point_id]) {
      const mk = store.mapMarkerByPid[touched_point_id];
      const st = store.state[touched_point_id]?.status || "todo";
      app.setMarkerStyle_(mk, st);
    } else {
      app.renderMapForArea_(area);
    }

    if (keepScroll) {
      requestAnimationFrame(()=> window.scrollTo({ top: y, behavior:"auto" }));
    }
  },

  setMarkerStyle_(mk, status){
    const isDone = (status === "done");
    const todoColor = getComputedStyle(document.documentElement).getPropertyValue('--todo').trim() || '#3d7cff';
    const doneColor = getComputedStyle(document.documentElement).getPropertyValue('--done').trim() || '#1fb56a';
    mk.setStyle({
      color: isDone ? doneColor : todoColor,
      fillColor: isDone ? doneColor : todoColor,
      fillOpacity: isDone ? 0.35 : 0.55,
      opacity: 1,
    });
  },

  getTodoPointsInArea(area){
    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    return pts.filter(p => (store.state[p.point_id]?.status || "todo") === "todo");
  },

  async startNavRecommended(){
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }

    const todoPts = app.getTodoPointsInArea(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const take = todoPts.slice(0, 8);
    const latlngs = take.map(p => encodeLoc(p.lat, p.lng));
    const url = buildDirUrl(latlngs, store.travel_mode);

    await postAction({
      action:"nav_start",
      actor_user_id: store.user_id,
      area_id: area,
      included_point_ids: take.map(p=>p.point_id),
      maps_url: url,
      client_time: new Date().toISOString()
    });

    window.location.href = url;
  },

  async pickNextPoint(){
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }
    const todoPts = app.getTodoPointsInArea(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const options = todoPts.slice(0, 25).map(p=>`#${p.order_reco} ${p.point_id} ${(p.name||"").slice(0,24)}`).join("\n");
    const input = prompt("æ¬¡ã«è¡Œãåœ°ç‚¹ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœªè¨ªå•ã‹ã‚‰ï¼‰\n\nå€™è£œï¼ˆå…ˆé ­25ï¼‰:\n" + options, todoPts[0].point_id);
    if (!input) return;
    const pid = input.trim();
    const idx = todoPts.findIndex(p=>p.point_id===pid);
    if (idx < 0) { ui.toast("æœªè¨ªå•ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const ordered = [todoPts[idx], ...todoPts.filter((_,i)=>i!==idx)].slice(0,8);
    const latlngs = ordered.map(p=>encodeLoc(p.lat, p.lng));
    const url = buildDirUrl(latlngs, store.travel_mode);

    await postAction({
      action:"nav_start",
      actor_user_id: store.user_id,
      area_id: area,
      included_point_ids: ordered.map(p=>p.point_id),
      maps_url: url,
      client_time: new Date().toISOString()
    });

    window.location.href = url;
  },

  async startSingleNav(point_id){
    const p = store.points.find(x=>x.point_id===point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
    const url = buildDirUrl([encodeLoc(p.lat,p.lng)], store.travel_mode);

    await postAction({
      action:"nav_start",
      actor_user_id: store.user_id,
      area_id: p.area_id,
      included_point_ids: [p.point_id],
      maps_url: url,
      client_time: new Date().toISOString()
    });

    window.location.href = url;
  },

  async handlePointAction(action, point_id){
    const p = store.points.find(x=>x.point_id===point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

    if (action === "single") {
      await app.startSingleNav(point_id);
      return;
    }

    let status = action; // "done" or "todo" or "memo"
    let memo = store.state[point_id]?.memo || "";

    if (action === "memo") {
      const m = prompt("ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", memo);
      if (m === null) return;
      memo = m.trim();
      status = store.state[point_id]?.status || "todo";
    }

    const data = await postAction({
      action:"state_update",
      actor_user_id: store.user_id,
      updates: [{
        point_id,
        status,
        memo,
        client_time: new Date().toISOString()
      }]
    });

    if (!data.ok) { ui.toast("æ›´æ–°å¤±æ•—ï¼š" + (data.error||"")); return; }
    const r = (data.results||[]).find(x=>x.point_id===point_id);
    if (r && !r.ok) { ui.toast("æ›´æ–°æ‹’å¦ï¼š" + (r.error||"")); return; }

    store.state[point_id] = { status, memo };
    ui.toast("æ›´æ–°ã—ã¾ã—ãŸ");

    // åŒã˜æŠ•ç¥¨åŒºç”»é¢ã®ã¾ã¾ã€éƒ¨åˆ†æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸æˆ»ã•ãªã„ï¼‰
    app.refreshCurrentPrecinct_({ keepScroll:true, touched_point_id: point_id });

    // summary ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å¤ã„æ‰±ã„ï¼ˆæ¬¡å›é–‹ã„ãŸã¨ãæ›´æ–°ã•ã‚Œã‚‹ï¼‰
    store.summary_loaded_at = 0;
  },

  /** -------- Leaflet Map -------- */
  renderMapForArea_(area){
    const mapWrap = document.getElementById("mapWrap");
    mapWrap.style.display = "block";

    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || a.point_id.localeCompare(b.point_id));

    if (!store.map) {
      store.map = L.map("map", { zoomControl:true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(store.map);
    }

    for (const m of store.mapMarkers) { try { m.remove(); } catch(e){} }
    store.mapMarkers = [];
    store.mapMarkerByPid = {};

    // åŒä¸€åº§æ¨™ãŒå¤šã„ã¨ãƒ”ãƒ³ãŒé‡ãªã£ã¦è¦‹ãˆãªã„ã®ã§ã€è¦‹ãŸç›®ã ã‘å°‘ã—æ•£ã‚‰ã™ï¼ˆjitterï¼‰
    const groups = new Map(); // key -> [p,...]
    for (const p of pts) {
      const lat = Number(p.lat), lng = Number(p.lng);
      if (!isFinite(lat) || !isFinite(lng)) continue;
      const key = lat.toFixed(6) + "," + lng.toFixed(6);
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(p);
    }

    function jitterLatLng(lat, lng, i, n){
      if (n <= 1) return [lat, lng];
      const rMeters = 2.2;
      const ang = (Math.PI * 2) * (i / n);
      const dLat = (rMeters * Math.cos(ang)) / 111111;
      const dLng = (rMeters * Math.sin(ang)) / (111111 * Math.cos(lat * Math.PI/180));
      return [lat + dLat, lng + dLng];
    }

    const todoColor = getComputedStyle(document.documentElement).getPropertyValue('--todo').trim() || '#3d7cff';
    const doneColor = getComputedStyle(document.documentElement).getPropertyValue('--done').trim() || '#1fb56a';

    for (const [key, arr] of groups.entries()) {
      for (let i=0; i<arr.length; i++) {
        const p = arr[i];
        const st = store.state[p.point_id]?.status || "todo";
        const isDone = (st === "done");

        const label = `#${p.order_reco} / ${p.point_id} ${isDone ? "ï¼ˆæ¸ˆï¼‰" : "ï¼ˆæœªï¼‰"}`;
        const lat0 = Number(p.lat), lng0 = Number(p.lng);
        const [lat, lng] = jitterLatLng(lat0, lng0, i, arr.length);

        const mk = L.circleMarker([lat, lng], {
          radius: 9,
          color: isDone ? doneColor : todoColor,
          weight: 2,
          fillColor: isDone ? doneColor : todoColor,
          fillOpacity: isDone ? 0.35 : 0.55,
          opacity: 1,
        });

        const btnSingle = `<button class="btn tiny">å˜ç‚¹ãƒŠãƒ“</button>`;
        const btnDone   = `<button class="btn tiny done">${isDone ? "æ¸ˆï¼ˆç¾åœ¨ï¼‰" : "æ¸ˆã«ã™ã‚‹"}</button>`;
        const btnTodo   = `<button class="btn tiny todo">æœªã«æˆ»ã™</button>`;
        const btnMemo   = `<button class="btn tiny memo">ãƒ¡ãƒ¢</button>`;

        const htmlPopup = `
          <div style="font-weight:1000; margin-bottom:8px; font-size:16px;">${label}</div>
          <div style="font-size:14px; opacity:1; white-space:pre-wrap; line-height:1.35;">
            ${(p.name||"").trim()}<br>${(p.address||"").trim()}
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
            <span data-a="single">${btnSingle}</span>
            <span data-a="done">${btnDone}</span>
            <span data-a="todo">${btnTodo}</span>
            <span data-a="memo">${btnMemo}</span>
          </div>
        `;

        mk.addTo(store.map).bindPopup(htmlPopup);

        mk.on('popupopen', (ev) => {
          const el = ev.popup.getElement();
          if (!el) return;
          const root = el.querySelector('.leaflet-popup-content');
          if (!root) return;

          const bind = (sel, fn) => {
            const span = root.querySelector(sel);
            if (!span) return;
            const b = span.querySelector('button');
            if (!b) return;
            b.onclick = fn;
          };

          bind('[data-a="single"]', async()=>{ mk.closePopup(); await app.startSingleNav(p.point_id); });
          bind('[data-a="done"]',   async()=>{ mk.closePopup(); await app.handlePointAction("done", p.point_id); });
          bind('[data-a="todo"]',   async()=>{ mk.closePopup(); await app.handlePointAction("todo", p.point_id); });
          bind('[data-a="memo"]',   async()=>{ mk.closePopup(); await app.handlePointAction("memo", p.point_id); });
        });

        store.mapMarkers.push(mk);
        store.mapMarkerByPid[p.point_id] = mk;
      }
    }

    const latlngsForBounds = pts
      .filter(p => isFinite(Number(p.lat)) && isFinite(Number(p.lng)))
      .map(p => [Number(p.lat), Number(p.lng)]);

    if (latlngsForBounds.length > 0) {
      const bounds = L.latLngBounds(latlngsForBounds);
      store.map.fitBounds(bounds, { padding:[30,30] });
      store.map.invalidateSize(true);
    } else {
      store.map.setView([35.0, 139.0], 12);
      store.map.invalidateSize(true);
    }
  },

  /** -------- Summary -------- */
  async summaryReload(force){
    if (!store.user_id) { app.showAuth(); return; }
    const ttlMs = 60 * 1000; // 1åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const fresh = store.summary && (Date.now() - store.summary_loaded_at) < ttlMs;
    if (!force && fresh) {
      app.renderSummaryUI_();
      return;
    }

    ui.toast("é›†è¨ˆã‚’å–å¾—ä¸­â€¦");
    const data = await postAction({ action:"summary", actor_user_id: store.user_id });
    if (!data.ok) {
      ui.toast("é›†è¨ˆå–å¾—å¤±æ•—ï¼š" + (data.error||""));
      return;
    }

    store.summary = data;
    store.summary_loaded_at = Date.now();
    app.renderSummaryUI_();
  },

  renderSummaryUI_(){
    const s = store.summary;
    if (!s) return;

    // scope è¡¨ç¤º
    const hint = document.getElementById("summaryScopeHint");
    const isAll = (s.scope === "all");
    hint.textContent = isAll
      ? "é–²è¦§ç¯„å›²ï¼šå…¨æŠ•ç¥¨åŒºï¼ˆplanner/allocatorï¼‰"
      : "é–²è¦§ç¯„å›²ï¼šè‡ªåˆ†ã®æ‹…å½“æŠ•ç¥¨åŒºã®ã¿ï¼ˆç¾å ´ãƒ¦ãƒ¼ã‚¶ï¼‰";

    // KPI
    document.getElementById("kpiTotal").textContent = String(s.kpi?.total ?? "-");
    document.getElementById("kpiTodo").textContent  = String(s.kpi?.todo  ?? "-");
    document.getElementById("kpiDone").textContent  = String(s.kpi?.done  ?? "-");

    // area selector
    const sel = document.getElementById("sumArea");
    const current = sel.value;
    sel.innerHTML = `<option value="">æŠ•ç¥¨åŒºï¼šã™ã¹ã¦</option>`;
    const areas = (s.by_area || []).slice().sort((a,b)=> String(a.area_id).localeCompare(String(b.area_id)));
    for (const a of areas) {
      const label = app.areaLabel_(a.area_id);
      const opt = document.createElement("option");
      opt.value = String(a.area_id);
      opt.textContent = `æŠ•ç¥¨åŒºï¼š${label}ï¼ˆæœª:${a.todo} / æ¸ˆ:${a.done}ï¼‰`;
      sel.appendChild(opt);
    }
    // å¯èƒ½ãªã‚‰é¸æŠç¶­æŒ
    if (current && Array.from(sel.options).some(o=>o.value===current)) {
      sel.value = current;
    } else {
      sel.value = "";
    }

    // status selectorã¯ãã®ã¾ã¾ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠç¶­æŒï¼‰
    app.renderSummaryList();
  },

  renderSummaryList(){
    const s = store.summary;
    const list = document.getElementById("summaryList");
    const cnt = document.getElementById("summaryCount");
    if (!s) { list.innerHTML = ""; cnt.textContent = "-"; return; }

    const area = document.getElementById("sumArea").value;
    const status = document.getElementById("sumStatus").value; // "", "todo", "done"

    const all = (s.points || []);
    const filtered = all.filter(p => {
      if (area && String(p.area_id) !== String(area)) return false;
      if (status && String(p.status) !== String(status)) return false;
      return true;
    });

    cnt.textContent = `è¡¨ç¤ºï¼š${filtered.length} ä»¶`;
    list.innerHTML = "";

    if (filtered.length === 0) {
      list.innerHTML = `
        <div class="item">
          <div class="itemTitle">è©²å½“ãªã—</div>
          <div class="itemSub">çµã‚Šè¾¼ã¿æ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚</div>
        </div>
      `;
      return;
    }

    // area -> order -> point_id
    filtered.sort((a,b)=> String(a.area_id).localeCompare(String(b.area_id)) || Number(a.order_reco)-Number(b.order_reco) || String(a.point_id).localeCompare(String(b.point_id)));

    for (const p of filtered) {
      const item = document.createElement("div");
      item.className = "item";

      const badge = (p.status === "done") ? `<span class="badge bDone">æ¸ˆ</span>` : `<span class="badge bTodo">æœª</span>`;
      const areaLabel = app.areaLabel_(p.area_id);

      const memoLine = (p.memo && String(p.memo).trim())
        ? `<div class="itemSub">ğŸ“ ${escapeHtml_(String(p.memo))}</div>`
        : `<div class="itemSub muted">ğŸ“ ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰</div>`;

      const byLine = (p.by_display_name || p.updated_by_name || "") ? ` / by: ${escapeHtml_(p.by_display_name || p.updated_by_name || "")}` : "";
      const timeLine = (p.updated_at || p.done_at || "") ? `${escapeHtml_(p.updated_at || p.done_at || "")}` : "-";

      item.innerHTML = `
        <div class="pointHeader">
          <div class="pointMain">
            <span class="mono">æŠ•ç¥¨åŒº:${areaLabel}</span>
            <span class="mono" style="margin-left:10px">#${p.order_reco}</span>
            <span class="mono" style="margin-left:8px">${escapeHtml_(p.point_id)}</span>
          </div>
          ${badge}
        </div>

        <div class="itemSub">${escapeHtml_((p.name||"").trim())}\n${escapeHtml_((p.address||"").trim())}</div>
        ${memoLine}
        <div class="muted" style="font-size:13px;margin-top:8px">
          æ›´æ–°ï¼š${timeLine}${byLine}
        </div>
      `;
      list.appendChild(item);
    }
  }
};

/** small helper */
function escapeHtml_(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

window.app = app;
app.init();
</script>
</body>
</html>
