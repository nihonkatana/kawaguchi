<!doctype html>
<html lang="ja">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é¸æŒ™æ²ç¤ºæ¿ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --bg:#0b0f1a; --card:#121a2b; --muted:#a7b0c0; --text:#eef2ff; --accent:#4f8cff;
      --danger:#ff5c5c; --ok:#2fe27d; --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}

    /* â˜…ã‚¹ãƒãƒ›å„ªå…ˆï¼šå…¨ä½“ã®ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ãã‚ */
    .wrap{max-width:820px;margin:0 auto;padding:16px 14px 110px}
    .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(to bottom, rgba(11,15,26,.98), rgba(11,15,26,.80));backdrop-filter: blur(10px);padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .row{display:flex;gap:10px;align-items:center}
    .space{justify-content:space-between}
    .title{font-size:18px;font-weight:900;letter-spacing:.02em}
    .pill{font-size:13px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);color:var(--muted)}
    .btn{border:none;border-radius:14px;padding:14px 16px;font-weight:900;font-size:15px;background:rgba(255,255,255,.10);color:var(--text);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent)}
    .btn.danger{background:var(--danger)}
    /* â˜…æ¸ˆãƒœã‚¿ãƒ³ï¼šç›®ç«‹ã¡ã™ãæŠ‘åˆ¶ï¼ˆèª¤èªé˜²æ­¢ï¼‰ */
    .btn.ok{background:rgba(47,226,125,.16); border:1px solid rgba(47,226,125,.28); color:var(--text)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14)}
    .btn.small{padding:11px 12px;font-size:14px;border-radius:12px}
    .btn.block{width:100%}

    .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:var(--muted);font-size:14px;line-height:1.5}
    .h2{font-size:17px;font-weight:950;margin:0 0 10px}
    .h3{font-size:15px;font-weight:900;margin:0 0 8px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .field{width:100%;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);outline:none;font-size:15px}
    .field::placeholder{color:rgba(167,176,192,.7)}

    .tabs{position:fixed;left:0;right:0;bottom:0;background:rgba(18,26,43,.96);backdrop-filter: blur(10px);border-top:1px solid rgba(255,255,255,.12);padding:12px 12px;display:flex;gap:10px;z-index:60}
    .tab{flex:1;text-align:center;padding:12px;border-radius:14px;font-weight:950;font-size:14px;color:var(--muted);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);cursor:pointer}
    .tab.active{color:var(--text);background:rgba(79,140,255,.20);border-color:rgba(79,140,255,.50)}

    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);color:var(--muted);font-weight:900}
    .bTodo{background:rgba(79,140,255,.18);color:#b8d4ff}
    .bDone{background:rgba(47,226,125,.16);color:#a9ffd0}

    .sep{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
    .list{display:flex;flex-direction:column;gap:12px}
    .item{padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05)}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTitle{font-weight:950;font-size:15px;line-height:1.25}
    .itemSub{font-size:13px;color:var(--muted);margin-top:6px;white-space:pre-wrap}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .right{display:flex;gap:8px;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12.5px}

    .toast{position:fixed;left:14px;right:14px;top:14px;z-index:100;display:none}
    .toast.show{display:block}
    .toast .card{margin:0}

    /* â˜…ãƒã‚¤ãƒ³ãƒˆè¡Œãƒ˜ãƒƒãƒ€ã‚’ç›®ç«‹ãŸã›ã‚‹ */
    .pointHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 12px; border-radius:14px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
    }
    .pointMain{font-weight:1000; font-size:16px; letter-spacing:.01em}
    .pointMeta{font-size:12px; color:rgba(167,176,192,.9)}

    /* MAP */
    #mapWrap{display:none}
    #map{
      width:100%;
      height:48vh;
      min-height:340px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }

    @media (max-width: 420px){
      .wrap{padding-bottom:120px}
      .title{font-size:18px}
      .btn{font-size:15px}
      .pill{font-size:13px}
      .pointMain{font-size:17px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row space">
      <div class="title">é¸æŒ™æ²ç¤ºæ¿ãƒŠãƒ“ãƒ«ãƒ¼ãƒˆ</div>
      <div class="right">
        <span id="rolePill" class="pill">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
        <button class="btn small ghost" onclick="app.openSettings()">è¨­å®š</button>
      </div>
    </div>

    <div class="row space" style="margin-top:12px;flex-wrap:wrap">
      <div class="row" style="flex-wrap:wrap">
        <span class="pill" id="userPill">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-</span>
        <span class="pill" id="modePill">ç§»å‹•ï¼šè»Š</span>
      </div>
      <button class="btn small" onclick="app.reload()">æ›´æ–°</button>
    </div>
  </div>

  <div class="toast" id="toast"><div class="card"><div id="toastText"></div></div></div>

  <div class="wrap">
    <!-- AUTH -->
    <div id="authView" class="card" style="display:none">
      <div class="h2">ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="muted">
        ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨è­˜åˆ¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        è­˜åˆ¥åã¯ã€LINEè¡¨ç¤ºåãŒã‚ã‚‹æ–¹ã¯ãã®è¡¨ç¤ºåã€‚LINEãŒãªã„æ–¹ã¯å‘¨å›²ãŒè­˜åˆ¥ã§ãã‚‹åå‰ï¼ˆç­åï¼‹æ°åãªã©ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      </div>
      <div style="margin-top:14px">
        <div class="h3">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰</div>
        <input id="inNick" class="field" placeholder="ä¾‹ï¼šã”ã¾ã¡ã‚ƒã‚“ / Aç­ç”°ä¸­" />
      </div>
      <div style="margin-top:12px">
        <div class="h3">è­˜åˆ¥åï¼ˆå¿…é ˆï¼‰</div>
        <input id="inIdName" class="field" placeholder="ä¾‹ï¼šæ˜çŸ³å®¶ ã‚´ãƒ / Aç­ ç”°ä¸­" />
      </div>
      <div class="sep"></div>
      <button class="btn primary block" onclick="app.register()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="muted" style="margin-top:12px">
        ç™»éŒ²ã§ããªã„å ´åˆï¼šè²¬ä»»è€…ã«ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã¨ã€Œè­˜åˆ¥åã€ã‚’ä¼ãˆã¦ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç™»éŒ²ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚<br>
        ç®¡ç†è€…ãŒäº‹å‰ã«ç™»éŒ²ã—ãŸãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã®ã€Œãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã¨ã€Œè­˜åˆ¥åã€ã«å®Œå…¨ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
      </div>
    </div>

    <!-- FIELD -->
    <div id="fieldView" style="display:none">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">æ‹…å½“æŠ•ç¥¨åŒºï¼ˆ1ã€œ97ï¼‰</div>
            <div class="muted">å‰²å½“ã•ã‚ŒãŸæŠ•ç¥¨åŒºã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
          </div>
          <button class="btn small" onclick="app.openTravelModePicker()">ç§»å‹•æ‰‹æ®µ</button>
        </div>
        <div class="sep"></div>
        <div id="precinctList" class="list"></div>
      </div>

      <div id="precinctDetail" class="card" style="display:none">
        <div class="row space">
          <div>
            <div class="h2" id="precTitle">æŠ•ç¥¨åŒº</div>
            <div class="muted" id="precSub"></div>
          </div>
          <button class="btn small ghost" onclick="app.closePrecinct()">æˆ»ã‚‹</button>
        </div>

        <div class="sep"></div>

        <!-- MAP: open precinct only -->
        <div id="mapWrap">
          <div class="h3">åœ°å›³ï¼ˆæŠ•ç¥¨åŒºå†…ï¼‰</div>
          <div class="muted" id="mapHint">ãƒ”ãƒ³ãŒé‡ãªã‚‹å ´åˆã¯è¦‹ãŸç›®ã ã‘ 1ã€œ3m ãšã‚‰ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</div>
          <div style="margin-top:10px"><div id="map"></div></div>
          <div class="sep"></div>
        </div>

        <div class="grid2">
          <button class="btn primary block" onclick="app.startNavRecommended()">æ¨å¥¨ãƒŠãƒ“é–‹å§‹ï¼ˆæœªè¨ªå•ï¼‰</button>
          <button class="btn block" onclick="app.pickNextPoint()">æ¬¡ç‚¹ã‚’é¸ã¶</button>
        </div>

        <div class="muted" style="margin-top:10px">
          ãƒ«ãƒ¼ãƒ«ï¼šæœªè¨ªå•(todo)ã®ã¿ãƒ»è¨­ç½®ç•ªå·é †ã€‚æœ€å¤§8åœ°ç‚¹ã‚’ GoogleãƒŠãƒ“ã«æ¸¡ã—ã¾ã™ã€‚
        </div>

        <div class="sep"></div>
        <div id="pointList" class="list"></div>
      </div>
    </div>

    <!-- ALLOCATOR -->
    <div id="allocView" style="display:none">
      <div class="card">
        <div class="h2">å‰²å½“ï¼ˆè²¬ä»»è€…ï¼‰</div>
        <div class="muted">
          è¤‡æ•°äººåŒæ™‚æ“ä½œã‚’æƒ³å®šã—ã€æŠ•ç¥¨åŒºã”ã¨ã« version ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ç«¶åˆã—ãŸå ´åˆã¯ã€Œæ›´æ–°ã€ã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚
        </div>
        <div class="sep"></div>

        <div class="h3">æ‹…å½“è€…æ¤œç´¢ï¼ˆusersï¼‰</div>
        <input id="inUserSearch" class="field" placeholder="è¡¨ç¤ºåã§æ¤œç´¢ï¼ˆä¾‹ï¼šãŸãªã‹ï¼‰" oninput="app.renderUserCandidates()" />
        <div id="userCandidates" class="list" style="margin-top:12px"></div>

        <div class="sep"></div>

        <div class="h3">æŠ•ç¥¨åŒºä¸€è¦§ï¼ˆ97ï¼‰</div>
        <div class="muted" style="margin-bottom:10px">è¤‡æ•°é¸æŠã—ã¦ä¸€æ‹¬å‰²å½“ã§ãã¾ã™ã€‚</div>

        <div class="grid2">
          <button class="btn ok block" onclick="app.bulkAssign()">é¸æŠã‚’å‰²å½“</button>
          <button class="btn danger block" onclick="app.bulkUnassign()">é¸æŠã‚’è§£é™¤</button>
        </div>

        <div style="margin-top:12px">
          <input id="inAssignNote" class="field" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šåˆå‰æ‹…å½“/å¼•ãç¶™ãç­‰ï¼‰" />
        </div>

        <div class="sep"></div>
        <div id="assignList" class="list"></div>
      </div>

      <div class="card">
        <div class="h2">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼ˆallowlistï¼‰</div>
        <div class="muted">ç¾å ´ã‹ã‚‰é€£çµ¡ãŒæ¥ãŸã‚‰ã€ãã®å ´ã§ç™»éŒ²ã§ãã¾ã™ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã€‚</div>
        <div class="sep"></div>

        <div class="h3">è¿½åŠ </div>
        <div class="grid2">
          <input id="alNick" class="field" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰" />
          <input id="alIdName" class="field" placeholder="è­˜åˆ¥åï¼ˆå¿…é ˆï¼‰" />
        </div>
        <div style="margin-top:12px">
          <input id="alNote" class="field" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šç­/ç‰¹å¾´/é›»è©±æœ«å°¾ç­‰ï¼‰" />
        </div>
        <div style="margin-top:12px">
          <button class="btn primary block" onclick="app.allowlistAdd()">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        </div>

        <div class="sep"></div>

        <div class="h3">ç„¡åŠ¹åŒ–</div>
        <input id="alDisableId" class="field" placeholder="allow_idï¼ˆä¾‹ï¼šal_000123ï¼‰" />
        <div style="margin-top:12px">
          <button class="btn danger block" onclick="app.allowlistDisable()">ã“ã® allow_id ã‚’ç„¡åŠ¹åŒ–</button>
        </div>
      </div>
    </div>

    <!-- SUMMARY (å…¨å“¡é–²è¦§å¯) -->
    <div id="sumView" style="display:none">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">é›†è¨ˆ</div>
            <div class="muted">å…¨æ²ç¤ºå ´ï¼ˆ717ï¼‰ã®ã€Œæœª/æ¸ˆã€ã¨ãƒ¡ãƒ¢ã‚’é–²è¦§ã§ãã¾ã™ã€‚</div>
          </div>
          <button class="btn small" onclick="app.loadSummary(true)">å†èª­è¾¼</button>
        </div>

        <div class="sep"></div>

        <div class="row" style="flex-wrap:wrap; gap:10px">
          <span class="pill" id="sumKpiAll">å…¨ä½“ï¼š-</span>
          <span class="pill" id="sumKpiTodo">æœªï¼š-</span>
          <span class="pill" id="sumKpiDone">æ¸ˆï¼š-</span>
        </div>

        <div class="sep"></div>

        <div class="h3">æŠ•ç¥¨åŒºã§çµã‚Šè¾¼ã¿</div>
        <select id="sumAreaSel" class="field" onchange="app.renderSummary()">
          <option value="">ã™ã¹ã¦</option>
        </select>

        <div class="sep"></div>

        <div id="sumList" class="list"></div>
      </div>
    </div>
  </div>

  <div class="tabs" id="tabs" style="display:none">
    <div class="tab active" id="tabField" onclick="app.switchTab('field')">ç¾å ´</div>
    <div class="tab" id="tabSum" onclick="app.switchTab('sum')">é›†è¨ˆ</div>
    <div class="tab" id="tabAlloc" onclick="app.switchTab('alloc')">è²¬ä»»è€…</div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1001;">
    <div style="background:var(--card); border:1px solid rgba(255,255,255,.12); margin:12vh auto; padding:16px; width:min(92vw,420px); border-radius:16px;">
      <div class="row space">
        <div class="h2" style="margin:0">è¨­å®š</div>
        <button class="btn small" onclick="app.closeSettings()">âœ•</button>
      </div>
      <div id="currentUserBox" class="muted" style="margin-top:12px"></div>
      <div class="sep"></div>
      <button class="btn danger block" onclick="app.logout()">ã“ã®ç«¯æœ«ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <div class="muted" style="margin-top:10px">
        â€» ç«¯æœ«ã‚’å…±ç”¨ã™ã‚‹å ´åˆã®ã¿ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚é€šå¸¸ã¯ä¸è¦ã§ã™ã€‚
      </div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/** =========================
 *  CONFIG
 * ========================= */
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbySjlT07rJLjORfIaa7QB9n7d-qaOhVvAcUBL2SppKYTTsqT8W1WqDdRcogx0lG8V-Vqw/exec";

/** =========================
 *  STATE
 * ========================= */
const store = {
  user_id: localStorage.getItem("user_id") || "",
  display_name: localStorage.getItem("display_name") || "",
  role: localStorage.getItem("role") || "",
  travel_mode: localStorage.getItem("travel_mode") || "driving", // default: driving
  assigned_areas: [],
  points: [],
  state: {},
  current_area: "",

  // leaflet
  map: null,
  mapMarkers: [],
  mapReadyArea: "",

  // summary
  summary: { kpi:null, byArea:[], points:[] }
};

const ui = {
  toast: (msg) => {
    const t = document.getElementById("toast");
    const tx = document.getElementById("toastText");
    tx.innerHTML = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2400);
  },
  setTop: () => {
    document.getElementById("userPill").textContent = store.display_name ? `ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š${store.display_name}` : "ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š-";
    const modeLabel = store.travel_mode === "walking" ? "å¾’æ­©" : "è»Š";
    document.getElementById("modePill").textContent = `ç§»å‹•ï¼š${modeLabel}`;
    document.getElementById("rolePill").textContent = store.role ? `role: ${store.role}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
  }
};

/** =========================
 *  HTTP
 * ========================= */
async function postAction(payload) {
  if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes("YOUR_GAS_WEBAPP_URL_HERE")) {
    ui.toast("GAS_WEBAPP_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    throw new Error("Missing GAS_WEBAPP_URL");
  }
  const res = await fetch(GAS_WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" }, // preflightå›é¿
    body: JSON.stringify(payload),
  });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error("Bad JSON response: " + text.slice(0,200)); }
  return data;
}

/** =========================
 *  UTIL
 * ========================= */
function escapeHtml_(s){
  s = String(s ?? "");
  return s
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function statusBadge(status){
  return (status === "done") ? `<span class="badge bDone">æ¸ˆ</span>` : `<span class="badge bTodo">æœª</span>`;
}
function isIOS_(){
  return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}
function encodeLoc(lat,lng){
  return `${Number(lat).toFixed(7)},${Number(lng).toFixed(7)}`;
}
function buildDirUrl(pointsLatLng, travelMode){
  const base = "https://www.google.com/maps/dir/";
  const parts = ["Current+Location", ...pointsLatLng];
  return base + parts.join("/") + `?travelmode=${encodeURIComponent(travelMode||"driving")}`;
}
function buildSingleNavUrl_(lat,lng, travelMode){
  // å˜ç‚¹ãƒŠãƒ“ï¼šiPhone ã¯ Apple Mapsã€ãã‚Œä»¥å¤–ã¯ Google Maps
  const ll = encodeLoc(lat,lng);
  if (isIOS_()) {
    const dirflg = (travelMode === "walking") ? "w" : "d";
    return `https://maps.apple.com/?daddr=${encodeURIComponent(ll)}&dirflg=${encodeURIComponent(dirflg)}`;
  }
  return buildDirUrl([ll], travelMode);
}

/** =========================
 *  MAP
 * ========================= */
function ensureMap_(){
  if (store.map) return;
  store.map = L.map('map', { zoomControl:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(store.map);
}
function clearMarkers_(){
  for (const m of store.mapMarkers) {
    try { store.map.removeLayer(m); } catch(e){}
  }
  store.mapMarkers = [];
}
function fitBoundsSafe_(boundsLatLng){
  if (!boundsLatLng || boundsLatLng.length === 0) return;
  const b = L.latLngBounds(boundsLatLng);
  store.map.fitBounds(b.pad(0.18));
  // display:noneâ†’block ç›´å¾Œã®ã‚ºãƒ¬å¯¾ç­–
  setTimeout(()=>store.map.invalidateSize(true), 80);
}

/** =========================
 *  APP
 * ========================= */
const app = {
  async init(){
    ui.setTop();
    if (!store.user_id) { app.showAuth(); return; }
    await app.bootstrap();
  },

  showAuth(){
    document.getElementById("authView").style.display = "block";
    document.getElementById("fieldView").style.display = "none";
    document.getElementById("allocView").style.display = "none";
    document.getElementById("sumView").style.display = "none";
    document.getElementById("tabs").style.display = "none";
  },

  async register(){
    const nickname = document.getElementById("inNick").value.trim();
    const id_name  = document.getElementById("inIdName").value.trim();
    if (!nickname || !id_name) { ui.toast("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    ui.toast("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
    const data = await postAction({ action:"register", nickname, id_name });
    if (!data.ok) {
      ui.toast(data.error === "NOT_ALLOWED" ? "ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæœªç™»éŒ²ï¼‰" : ("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + (data.error || "ä¸æ˜")));
      return;
    }

    store.user_id = data.user.user_id;
    store.display_name = data.user.display_name;
    store.role = data.user.role;

    localStorage.setItem("user_id", store.user_id);
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);
    localStorage.setItem("travel_mode", store.travel_mode);

    ui.setTop();
    await app.bootstrap();
  },

  async bootstrap(){
    ui.toast("èª­ã¿è¾¼ã¿ä¸­â€¦");
    const data = await postAction({ action:"bootstrap", user_id: store.user_id });
    if (!data.ok) { ui.toast("èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™"); app.logout(); return; }

    store.display_name = data.user.display_name || store.display_name;
    store.role = data.user.role || store.role;
    localStorage.setItem("display_name", store.display_name);
    localStorage.setItem("role", store.role);

    store.assigned_areas = data.assigned_areas || [];
    store.points = data.points || [];
    store.state = data.state || {};

    ui.setTop();

    // tabs
    document.getElementById("tabs").style.display = "flex";
    const isAdmin = (store.role === "allocator" || store.role === "planner");
    document.getElementById("tabAlloc").style.display = isAdmin ? "block" : "none";

    app.switchTab("field");
    app.renderPrecinctList();
  },

  async reload(){
    if (!store.user_id) { app.showAuth(); return; }
    await app.bootstrap();
  },

  logout(){
    localStorage.removeItem("user_id");
    localStorage.removeItem("display_name");
    localStorage.removeItem("role");
    // travel_mode stays
    store.user_id = "";
    store.display_name = "";
    store.role = "";
    store.assigned_areas = [];
    store.points = [];
    store.state = {};
    store.current_area = "";
    ui.setTop();
    app.showAuth();
  },

  switchTab(which){
    const isAdmin = (store.role === "allocator" || store.role === "planner");

    document.getElementById("tabField").classList.toggle("active", which==="field");
    document.getElementById("tabSum").classList.toggle("active", which==="sum");
    const tabAlloc = document.getElementById("tabAlloc");
    if (tabAlloc) tabAlloc.classList.toggle("active", which==="alloc");

    document.getElementById("fieldView").style.display = which==="field" ? "block" : "none";
    document.getElementById("sumView").style.display = which==="sum" ? "block" : "none";
    document.getElementById("allocView").style.display = which==="alloc" ? "block" : "none";
    document.getElementById("authView").style.display = "none";

    if (which==="alloc") {
      if (!isAdmin) { ui.toast("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"); app.switchTab("field"); return; }
      app.loadAllocatorData().catch(err => ui.toast("å‰²å½“ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ï¼š" + err.message));
    }
    if (which==="sum") {
      app.loadSummary(false).catch(err => ui.toast("é›†è¨ˆå–å¾—ã«å¤±æ•—ï¼š" + err.message));
    }
  },

  openTravelModePicker(){
    const current = store.travel_mode;
    const msg = `å…¥åŠ›ï¼šDï¼ˆè»Šï¼‰/ Wï¼ˆå¾’æ­©ï¼‰\n\nç¾åœ¨ï¼š${current==="walking"?"W":"D"}`;
    const chosen = prompt(msg, current==="walking" ? "W" : "D");
    if (!chosen) return;
    const v = chosen.trim().toUpperCase();
    if (!["D","W"].includes(v)) { ui.toast("å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); return; }
    store.travel_mode = (v === "W") ? "walking" : "driving";
    localStorage.setItem("travel_mode", store.travel_mode);
    ui.setTop();
    ui.toast("ç§»å‹•æ‰‹æ®µã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
    if (store.current_area) app.openPrecinct(store.current_area);
  },

  areaLabel_(areaId){
    // P001 -> 1
    const m = String(areaId||"").match(/P0*([0-9]+)/);
    return m ? String(Number(m[1])) : String(areaId||"");
  },

  /** -------- Field: precinct list/detail -------- */
  renderPrecinctList(){
    const el = document.getElementById("precinctList");
    el.innerHTML = "";

    if (!store.assigned_areas || store.assigned_areas.length === 0) {
      el.innerHTML = `
        <div class="item">
          <div class="itemTitle">å‰²å½“ãªã—</div>
          <div class="itemSub">è²¬ä»»è€…ãŒæŠ•ç¥¨åŒºã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¾ã§ã€ã“ã“ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
        </div>`;
      return;
    }

    const pointsByArea = new Map();
    for (const p of store.points) {
      if (!pointsByArea.has(p.area_id)) pointsByArea.set(p.area_id, []);
      pointsByArea.get(p.area_id).push(p);
    }

    for (const area of store.assigned_areas.slice().sort()) {
      const pts = (pointsByArea.get(area) || []).slice().sort((a,b)=>a.order_reco-b.order_reco || String(a.point_id).localeCompare(String(b.point_id)));
      const total = pts.length;
      const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;
      const done = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="done").length;

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">æŠ•ç¥¨åŒºï¼š${app.areaLabel_(area)}</div>
            <div class="itemSub">åœ°ç‚¹ï¼š${total} / æœªï¼š${todo} / æ¸ˆï¼š${done}</div>
          </div>
          <div class="right">
            <button class="btn small primary">é–‹ã</button>
          </div>
        </div>
      `;
      item.querySelector("button").onclick = () => app.openPrecinct(area);
      el.appendChild(item);
    }
  },

  openPrecinct(areaId){
    store.current_area = areaId;
    document.getElementById("precinctDetail").style.display = "block";

    const pts = store.points
      .filter(p => p.area_id === areaId)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || String(a.point_id).localeCompare(String(b.point_id)));

    const total = pts.length;
    const todo = pts.filter(x => (store.state[x.point_id]?.status || "todo")==="todo").length;
    const modeLabel = store.travel_mode==="walking" ? "å¾’æ­©" : "è»Š";

    document.getElementById("precTitle").textContent = `æŠ•ç¥¨åŒºï¼š${app.areaLabel_(areaId)}`;
    document.getElementById("precSub").textContent = `åœ°ç‚¹ï¼š${total} / æœªï¼š${todo} / ç§»å‹•ï¼š${modeLabel}`;

    app.renderMapForArea_(areaId);
    app.renderPointList();
    window.scrollTo({top:0, behavior:"smooth"});
  },

  closePrecinct(){
    store.current_area = "";
    document.getElementById("precinctDetail").style.display = "none";
    document.getElementById("mapWrap").style.display = "none";
    app.renderPrecinctList();
  },

  renderMapForArea_(areaId){
    const pts = store.points
      .filter(p => p.area_id === areaId)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || String(a.point_id).localeCompare(String(b.point_id)));

    document.getElementById("mapWrap").style.display = "block";
    ensureMap_();
    clearMarkers_();

    let okCount = 0;
    let badCount = 0;
    const boundsLatLng = [];
    store._dup = new Map();

    for (const p of pts) {
      const lat = Number(p.lat);
      const lng = Number(p.lng);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) { badCount++; continue; }

      okCount++;

      // åŒä¸€åº§æ¨™ã®ãƒ”ãƒ³ãŒé‡ãªã£ã¦ã€Œå°‘ãªãè¦‹ãˆã‚‹ã€å•é¡Œã‚’å›é¿ï¼ˆè¦‹ãŸç›®ã®ã¿ã®å¾®å°ã‚ºãƒ¬ï¼‰
      const key = lat.toFixed(6) + "," + lng.toFixed(6);
      const n = store._dup.get(key) || 0;
      store._dup.set(key, n + 1);

      let lat2 = lat, lng2 = lng;
      if (n > 0) {
        const meters = Math.min(3, 1.3 * n); // 1.3m, 2.6m, 3m...
        const ang = (n * 47) * Math.PI / 180;
        const dLat = (meters / 111320) * Math.cos(ang);
        const dLng = (meters / (111320 * Math.cos(lat * Math.PI / 180))) * Math.sin(ang);
        lat2 = lat + dLat;
        lng2 = lng + dLng;
      }

      boundsLatLng.push([lat2,lng2]);

      const st = store.state[p.point_id]?.status || "todo";
      const badge = (st === "done") ? "æ¸ˆ" : "æœª";

      const mk = L.marker([lat2,lng2]).addTo(store.map);
      mk.bindPopup(
        `<div class="mono" style="font-size:13px;line-height:1.35">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">#${p.order_reco} ${escapeHtml_(p.point_id)}ï¼ˆ${badge}ï¼‰</div>
          <div>${escapeHtml_((p.name||"").trim())}</div>
          <div style="color:#a7b0c0;margin-top:4px">${escapeHtml_((p.address||"").trim())}</div>
        </div>`
      );
      store.mapMarkers.push(mk);
    }

    const hint = document.getElementById("mapHint");
    hint.textContent = (badCount>0)
      ? `åœ°å›³ï¼š${okCount}ä»¶è¡¨ç¤º / ${badCount}ä»¶ã¯åº§æ¨™ä¸æ­£ã§ã‚¹ã‚­ãƒƒãƒ—`
      : `åœ°å›³ï¼š${okCount}ä»¶è¡¨ç¤ºï¼ˆåŒä¸€åº§æ¨™ã¯è¦‹ãŸç›®ã ã‘ 1ã€œ3m ãšã‚‰ã—ã¾ã™ï¼‰`;

    fitBoundsSafe_(boundsLatLng);
  },

  renderPointList(){
    const area = store.current_area;
    const list = document.getElementById("pointList");
    list.innerHTML = "";
    if (!area) return;

    const pts = store.points
      .filter(p => p.area_id === area)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || String(a.point_id).localeCompare(String(b.point_id)));

    for (const p of pts) {
      const st = store.state[p.point_id]?.status || "todo";
      const memo = store.state[p.point_id]?.memo || "";
      const item = document.createElement("div");
      item.className = "item";

      item.innerHTML = `
        <div class="pointHeader">
          <div>
            <div class="pointMain">#${p.order_reco} <span class="mono">${escapeHtml_(p.point_id)}</span> ${statusBadge(st)}</div>
            <div class="pointMeta">${escapeHtml_((p.name||"").trim())}</div>
          </div>
          <button class="btn small" title="å˜ç‚¹ãƒŠãƒ“">å˜ç‚¹ãƒŠãƒ“</button>
        </div>

        <div class="itemSub">${escapeHtml_((p.address||"").trim())}</div>
        ${memo ? `<div class="itemSub">ğŸ“ ${escapeHtml_(memo)}</div>` : ``}

        <div class="actions">
          <button class="btn small ok" data-act="done">æ¸ˆ</button>
          <button class="btn small" data-act="todo">æœªã«æˆ»ã™</button>
          <button class="btn small ghost" data-act="memo">ãƒ¡ãƒ¢</button>
        </div>
      `;

      item.querySelector(`button[title="å˜ç‚¹ãƒŠãƒ“"]`).onclick = () => app.startSingleNav(p.point_id);
      item.querySelectorAll(`button[data-act]`).forEach(btn=>{
        btn.onclick = () => app.handlePointAction(btn.dataset.act, p.point_id);
      });

      list.appendChild(item);
    }
  },

  getTodoPointsInArea(areaId){
    const pts = store.points
      .filter(p => p.area_id === areaId)
      .slice()
      .sort((a,b)=>a.order_reco-b.order_reco || String(a.point_id).localeCompare(String(b.point_id)));

    return pts.filter(p => (store.state[p.point_id]?.status || "todo") === "todo");
  },

  async startNavRecommended(){
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }

    const todoPts = app.getTodoPointsInArea(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const take = todoPts.slice(0, 8);
    const latlngs = take.map(p => encodeLoc(p.lat, p.lng));
    const url = buildDirUrl(latlngs, store.travel_mode);

    await postAction({
      action:"nav_start",
      actor_user_id: store.user_id,
      area_id: area,
      included_point_ids: take.map(p=>p.point_id),
      maps_url: url,
      client_time: new Date().toISOString()
    });

    window.location.href = url;
  },

  async pickNextPoint(){
    const area = store.current_area;
    if (!area) { ui.toast("æŠ•ç¥¨åŒºã‚’é–‹ã„ã¦ãã ã•ã„"); return; }
    const todoPts = app.getTodoPointsInArea(area);
    if (todoPts.length === 0) { ui.toast("æœªè¨ªå•ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const options = todoPts.slice(0, 20).map(p=>`#${p.order_reco} ${p.point_id} ${(p.name||"").slice(0,20)}`).join("\n");
    const input = prompt("æ¬¡ã«è¡Œãåœ°ç‚¹ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœªè¨ªå•ã‹ã‚‰ï¼‰\n\nå€™è£œï¼ˆå…ˆé ­20ï¼‰:\n" + options, todoPts[0].point_id);
    if (!input) return;
    const pid = input.trim();
    const idx = todoPts.findIndex(p=>p.point_id===pid);
    if (idx < 0) { ui.toast("æœªè¨ªå•ã® point_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const ordered = [todoPts[idx], ...todoPts.filter((_,i)=>i!==idx)].slice(0,8);
    const latlngs = ordered.map(p=>encodeLoc(p.lat, p.lng));
    const url = buildDirUrl(latlngs, store.travel_mode);

    await postAction({
      action:"nav_start",
      actor_user_id: store.user_id,
      area_id: area,
      included_point_ids: ordered.map(p=>p.point_id),
      maps_url: url,
      client_time: new Date().toISOString()
    });

    window.location.href = url;
  },

  async startSingleNav(point_id){
    const p = store.points.find(x=>x.point_id===point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

    const url = buildSingleNavUrl_(p.lat, p.lng, store.travel_mode);

    await postAction({
      action:"nav_start",
      actor_user_id: store.user_id,
      area_id: p.area_id,
      included_point_ids: [p.point_id],
      maps_url: url,
      client_time: new Date().toISOString()
    });

    window.location.href = url;
  },

  async handlePointAction(action, point_id){
    const p = store.points.find(x=>x.point_id===point_id);
    if (!p) { ui.toast("åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

    let status = action;
    let memo = store.state[point_id]?.memo || "";

    if (action === "memo") {
      const m = prompt("ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", memo);
      if (m === null) return;
      memo = m.trim();
      status = store.state[point_id]?.status || "todo";
    }

    const data = await postAction({
      action:"state_update",
      actor_user_id: store.user_id,
      updates: [{
        point_id,
        status,
        memo,
        client_time: new Date().toISOString()
      }]
    });

    if (!data.ok) { ui.toast("æ›´æ–°å¤±æ•—ï¼š" + (data.error||"")); return; }
    const r = (data.results||[]).find(x=>x.point_id===point_id);
    if (r && !r.ok) { ui.toast("æ›´æ–°æ‹’å¦ï¼š" + (r.error||"")); return; }

    store.state[point_id] = { status, memo };
    ui.toast("æ›´æ–°ã—ã¾ã—ãŸ");
    app.openPrecinct(p.area_id);
  },

  /** -------- Summary -------- */
  async loadSummary(force){
    const resp = await postAction({ action:"summary", actor_user_id: store.user_id });
    if (!resp.ok) throw new Error(resp.error || "summary_failed");

    store.summary.kpi = resp.kpi || null;
    store.summary.byArea = resp.by_area || [];
    store.summary.points = resp.points || [];

    if (force) {
      const sel = document.getElementById("sumAreaSel");
      if (sel) {
        while (sel.options.length > 1) sel.remove(1);
        sel.value = "";
      }
    }
    app.renderSummary();
  },

  renderSummary(){
    const k = store.summary.kpi || { total:0, todo:0, done:0 };
    document.getElementById("sumKpiAll").textContent  = `å…¨ä½“ï¼š${k.total}`;
    document.getElementById("sumKpiTodo").textContent = `æœªï¼š${k.todo}`;
    document.getElementById("sumKpiDone").textContent = `æ¸ˆï¼š${k.done}`;

    const sel = document.getElementById("sumAreaSel");
    if (sel && sel.options.length <= 1) {
      for (const a of (store.summary.byArea || [])) {
        const opt = document.createElement("option");
        opt.value = a.area_id;
        opt.textContent = `æŠ•ç¥¨åŒº ${app.areaLabel_(a.area_id)}ï¼ˆæœª:${a.todo} / æ¸ˆ:${a.done}ï¼‰`;
        sel.appendChild(opt);
      }
    }

    const area = sel ? String(sel.value || "") : "";
    const list = document.getElementById("sumList");
    list.innerHTML = "";

    const pts = (store.summary.points || [])
      .filter(p => !area || p.area_id === area)
      .slice()
      .sort((a,b)=> String(a.area_id).localeCompare(String(b.area_id)) || Number(a.order_reco||0)-Number(b.order_reco||0) || String(a.point_id).localeCompare(String(b.point_id)));

    if (pts.length === 0) {
      list.innerHTML = `<div class="item"><div class="itemTitle">è©²å½“ãªã—</div><div class="itemSub">è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>`;
      return;
    }

    for (const p of pts) {
      const st = (p.status === "done") ? "done" : "todo";
      const badge = statusBadge(st);
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="pointHeader">
              <div class="pointMain">æŠ•ç¥¨åŒº ${app.areaLabel_(p.area_id)} / #${p.order_reco} <span class="mono">${escapeHtml_(p.point_id)}</span> ${badge}</div>
            </div>
            <div class="itemSub">${escapeHtml_((p.name||"").trim())}\n${escapeHtml_((p.address||"").trim())}</div>
            ${p.memo ? `<div class="itemSub">ğŸ“ ${escapeHtml_(p.memo)}</div>` : ``}
            <div class="itemSub">æ›´æ–°ï¼š${escapeHtml_(p.updated_at || "-")} / by: ${escapeHtml_(p.by_display_name || "-")}</div>
          </div>
        </div>
      `;
      list.appendChild(item);
    }
  },

  /** -------- Allocator (ã¾ã UIã¯ç¶­æŒï¼šä»Šå›ã®ä¸»ç›®çš„ã¯é›†è¨ˆ+ç¾å ´UI) -------- */
  async loadAllocatorData(){
    const usersResp = await postAction({ action:"alloc_list_users", actor_user_id: store.user_id });
    const assnResp  = await postAction({ action:"alloc_list_assignments", actor_user_id: store.user_id });
    if (!usersResp.ok || !assnResp.ok) throw new Error("alloc_load_failed");
    // ï¼ˆã“ã®å…ˆã® allocator UI ã¯ã€ã‚ãªãŸã®ç¾è¡Œç‰ˆã«åˆã‚ã›ã¦æ‹¡å¼µã—ã¦ã„ãã¾ã™ï¼‰
    ui.toast("allocator ãƒ‡ãƒ¼ã‚¿å–å¾—OKï¼ˆUIã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§èª¿æ•´ï¼‰");
  },

  /** -------- Settings -------- */
  openSettings(){
    const modal = document.getElementById("settingsModal");
    const box = document.getElementById("currentUserBox");
    box.textContent = store.display_name ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${store.display_name}ï¼ˆ${store.role}ï¼‰` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
    modal.style.display = "block";
  },
  closeSettings(){
    document.getElementById("settingsModal").style.display = "none";
  },
};

window.app = app;
app.init();
</script>
</body>
</html>
